{% extends "home/base.html" %}
{% load staticfiles %}

{% block content %}
<a id="dlink"  style="display:none;"></a>
<input type="button" onclick="tableToExcel('couplings', 'Coupling data', 'MyFile.xls')" value="Export to Excel">



<table class="row-border text-center compact text-nowrap" id="couplings">
    <thead>
        <tr>
            <th>
                Class
            </th>
            <th colspan=2 class="border-right">
                Receptor
            </th>
            <th colspan="4" class="border-right">
                G protein coupling (merged sources)
            </th>
            <th colspan="4" class="border-right">
                <a href="http://www.guidetopharmacology.org/GRAC/ReceptorFamiliesForward?type=GPCR">Guide To Pharmacology database</a>
            </th>
            <th colspan="4" class="border-right">
                Asuka Inoue et al., Cell 2019
            </th>
            <th colspan="2" class="border-right">
                Gs
            </th>
            <th colspan="4" class="border-right">
                Gi/o
            </th>
            <th colspan="3" class="border-right">
                Gq/11
            </th>
            <th colspan="2">
                G12/13
            </th>
        </tr>
        <tr>
            <th>
            </th>
            <th>
            </th>
            <th class="border-right">
            </th>
            <th></th>
            
                <th></th>
            
                <th></th>
            
                <th class="border-right"></th>
            
            
                <th></th>
            
                <th></th>
            
                <th></th>
            
                <th class="border-right"></th>
            
            
                <th></th>
            
                <th></th>
            
                <th></th>
            
                <th class="border-right"></th>
                
                <th>gnal</th>
            
                <th class="border-right">gnas2</th>
            
        
                <th>gnai1</th>
            
                <th>gnai3</th>
            
                <th>gnao</th>
            
                <th class="border-right">gnaz</th>
            
        
                <th>gna14</th>
            
                <th>gna15</th>
            
                <th class="border-right">gnaq</th>
            
                   
                <th>gna12</th>
            
                <th>gna13</th>
        </tr>

    </thead>

    <tbody>
{% for p,vals in data.items %}
    <tr>
        <td class="text-left">{{vals.0}}</td>
        <td class="text-left">{{vals.1}}</td>
        <td class="text-left border-right">{{vals.2|safe}}</td>
        <td class="greyscale">{{vals.3}}</td>
        <td class="greyscale">{{vals.4}}</td>
        <td class="greyscale">{{vals.5}}</td>
        <td class="greyscale border-right">{{vals.6}}</td>
        <td class="greyscale">{{vals.7}}</td>
        <td class="greyscale">{{vals.8}}</td>
        <td class="greyscale">{{vals.9}}</td>
        <td class="greyscale border-right">{{vals.10}}</td>
        <td class="greyscale">{{vals.11}}</td>
        <td class="greyscale">{{vals.12}}</td>
        <td class="greyscale">{{vals.13}}</td>
        <td class="greyscale border-right">{{vals.14}}</td>
        <td class="greyscale">{{vals.15}}</td>
        <td class="greyscale border-right">{{vals.16}}</td>
        <td class="greyscale">{{vals.17}}</td>
        <td class="greyscale">{{vals.18}}</td>
        <td class="greyscale">{{vals.19}}</td>
        <td class="greyscale border-right">{{vals.20}}</td>
        <td class="greyscale">{{vals.21}}</td>
        <td class="greyscale">{{vals.22}}</td>
        <td class="greyscale border-right">{{vals.23}}</td>
        <td class="greyscale">{{vals.24}}</td>
        <td class="greyscale">{{vals.25}}</td>
    </tr>
{% endfor %}
    </tbody>
    </table>

{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script type="text/javascript">
        $(document).ready(function() {

            oTable = $('#couplings').DataTable({
                    'scrollX': true,
                    // 'paging': true,
                    // 'autoWidth': true,
                    // "ordering": false,

                    scrollY:        '70vh',
                    // scrollCollapse: true,
                    paging:         false,
                    columnDefs: [
                      { targets: 'no-sort', orderable: false }
                    ],
                    "aaSorting": []
                  });

                  yadcf.init(oTable,
                    [   
                        {
                            column_number : 0,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Class",
                            filter_reset_button_text: false,
                        },
                        {
                            column_number : 1,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Uniprot",
                            filter_reset_button_text: false,
                        },
                        {
                            column_number : 2,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            //column_data_type: "html",
                            html_data_type: "text",
                            filter_default_label: "NC-IUPHAR",
                            filter_match_mode : "exact",
                            filter_reset_button_text: false,
                            select_type_options: {
                                width: '85px',
                            }
                        },

                        {
                            column_number : 3,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 4,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 5,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 6,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 7,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 8,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 9,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 10,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 11,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 12,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 13,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 14,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 15,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 16,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 17,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 18,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 19,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 20,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 21,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 22,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 23,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 24,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 25,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        // {
                        //     column_number : 1,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     select_type_options: {
                        //       width: '70px'
                        //     },
                        //     filter_default_label: "PDB",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 2,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     column_data_type: "html",
                        //     html_data_type: "text",
                        //     filter_default_label: "Receptor",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 3,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     html_data_type: "text",
                        //     select_type_options: {
                        //       width: '150px'
                        //     },
                        //     filter_default_label: "Family",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 4,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     filter_default_label: "Species",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 5,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     select_type_options: {
                        //         minimumResultsForSearch: -1 // remove search box
                        //     },
                        //     filter_default_label: "State",
                        //     column_data_type: "html",
                        //     html_data_type: "text",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,

                        // },
                        // {
                        //     column_number : 6,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     filter_default_label: "Representative",
                        //     filter_reset_button_text: false,

                        // },
                    ],
                    {
                        cumulative_filtering: false
                    }
                );

            yadcf.exResetAllFilters(oTable);

            $('.greyscale').each(function() {
                var s = $(this).html();
                if (s == "-") return
                if (!s) return
                frequency = 0.5-(s/-2.1)*.5;
                var rgb = { r: 255-frequency*255, g: 255-frequency*255, b: 255-frequency*255 };
                var hex = rgb2hex(rgb.r, rgb.g, rgb.b);
                if (s == 'primary') hex = "#808080";
                if (s == 'secondary') hex = "#bebebe";
                if (s == 'No coupling') hex = "#f9f9f9";
                $(this).attr('bgcolor',hex);
            });

            $('.dataTables_scrollBody').append('<div id=overlay><table id="overlay_table" class="row-border text-center compact dataTable no-footer text-nowrap"><tbody></tbody></table></div>');
            $("#overlay").css({ top: '0px' });
            $("#overlay").css('position', 'absolute');
            $("#overlay").css('background', 'white');

            $("#overlay_table tbody tr").remove(); 
            var $target = $("#overlay_table tbody");
            $("#couplings tbody tr").each(function() {
                var $tds = $(this).children(),
                    $row = $("<tr></tr>");
                $row.append($tds.eq(0).clone()).append($tds.eq(1).clone()).append($tds.eq(2).clone()).appendTo($target);
            });

            $('#couplings').on( 'draw.dt', function (e,oSettings) {
                $("#overlay_table tbody tr").remove(); 
                var $target = $("#overlay_table tbody");
                $("#couplings tbody tr").each(function() {
                    var $tds = $(this).children(),
                        $row = $("<tr></tr>");
                    $row.append($tds.eq(0).clone()).append($tds.eq(1).clone()).append($tds.eq(2).clone()).appendTo($target);
                });
            });


            $("#overlay").hide();

            console.log('bind scroll');
            var left = 0;
            var old_left = 0;
            var lastMove = (new Date()).getTime();
            $('.dataTables_scrollBody').scroll(function(){
                // console.log('dataTables_scroll',$('.dataTables_scrollBody').scrollLeft());

                left = $('.dataTables_scrollBody').scrollLeft();
                // if (left!=old_left) $("#overlay").animate({ left: '-=300' });
                if (left!=old_left) $("#overlay").hide();
                // console.log('last scroll',((new Date()).getTime()-lastMove));
                // if (((new Date()).getTime()-lastMove)<200) clearTimeout($.data(this, 'scrollTimer'));
                clearTimeout($.data(this, 'scrollTimer'));
                clearTimeout($.data(this, 'fadeout'));
                $.data(this, 'scrollTimer', setTimeout(function() {
                    // do something
                    left = $('.dataTables_scrollBody').scrollLeft();
                    old_left = left;
                    // if (left!=old_left) $("#overlay").hide();
                    if (left>200) {
                        $("#overlay").css({ left: left+'px' });
                        $("#overlay").fadeIn();
                        lastMove = (new Date()).getTime();
                        // $("#overlay").animate({ left: left+'px' });
                    } else {
                        $.data(this, 'fadeout', setTimeout(function() {
                            if ($("#overlay").is(":visible") && left<200) {
                                console.log("FADEOUT"); 
                                $("#overlay").animate({ left: '0px' });
                                $("#overlay").fadeOut("slow");
                            }
                        },200));
                    }
                }, 200));
            });

        });
        function rgb2hex(r,g,b) {
            r = Math.round(r).toString(16);
            g = Math.round(g).toString(16);
            b = Math.round(b).toString(16);

            if (r.length == 1)
                r = '0' + r;

            if (g.length == 1)
                g = '0' + g;

            if (b.length == 1)
                b = '0' + b;

            return '#' + r + g + b;
        }

        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,',
                template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
                base64 = function (s) {
                    return window.btoa(unescape(encodeURIComponent(s)))
                }, format = function (s, c) {
                    return s.replace(/{(\w+)}/g, function (m, p) {
                        return c[p];
                    })
                }
            return function (table, name, filename) {
                if (!table.nodeType) table = document.getElementById(table)
                var ctx = {
                    worksheet: name || 'Worksheet',
                    table: table.innerHTML
                }
           document.getElementById("dlink").href = uri + base64(format(template, ctx));
                    document.getElementById("dlink").download = filename;
                    document.getElementById("dlink").click();
            }
        })()




        $(function(){
            $('.ali-scroll-div').scroll(function(){
                $('.ali-main-div')
                    .scrollLeft($('.ali-scroll-div').scrollLeft());
                $(".ali-main-div")
                    .scrollTop($('.ali-main-div').scrollTop());
            });
            $('.ali-first-col-div').scroll(function(){
                $(".ali-main-div")
                    .scrollTop($('.ali-first-col-div').scrollTop());
            });
            $('.ali-main-div').scroll(function(){
                $('.ali-scroll-div')
                    .scrollLeft($('.ali-main-div').scrollLeft());
                $(".ali-first-col-div")
                    .scrollTop($('.ali-main-div').scrollTop());
            });
        });


    </script>
{% endblock %}
{% block addon_css %}
<link href="{% static 'home/css/alignment.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <style type="text/css">
        #content {
            width: 100%;
        }
        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            /*font-family: sans-serif;*/
            font-size: 100%;
            /*font-weight: bold;*/
        }
        .select2-container-multi .select2-choices .select2-search-field input {
            padding: 0px;
        }
        .border-right {
          border-right: 1px solid black;
        }

        td {
            height: 20px;
        }
    </style>
{% endblock %}