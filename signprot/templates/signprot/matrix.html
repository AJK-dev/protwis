{% extends "home/base.html" %}
{% load staticfiles %}

{% block addon_css %}
<link href="{% static 'home/css/signprotmat.css' %}" rel="stylesheet">
<link href="{% static 'home/css/jquery.dataTables.min.css' %}" rel="stylesheet">
<link href="{% static 'home/css/select.dataTables.min.css' %}" rel="stylesheet">
<link href="{% static 'home/css/buttons.dataTables.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<h1 class="page-header">GPCR - Signal Protein Interaction Matrix</h1>
<p>
    Display the interaction between one or multiple GPCR/G-protein complex interfaces.
</p>

<div class="row">
    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">Interface(s)</h3>
            </div>

            <div class="panel-body">
                <h5><span id='interface-count' class="crystal-count">0 interfaces selected.</span></h5>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#interface-modal-table">Select Interface</button>
            </div>

        </div>
    </div>

    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">Add additional PDB(s)</h3>
            </div>

            <div class="panel-body">
                <h5><span id='pdb-count' class="crystal-count">0 PDBs selected.</span></h5>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#pdb-modal-table">Add PDB</button>
            </div>

        </div>
    </div>


    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">Sequence Signature</h3>
            </div>

            <div class="panel-body">
                <p>Click the button in order to calculate the sequence signature of the set of GPCR structures and your appended PDBs.</p>
                <button type="button" class="btn btn-primary" onClick="document.querySelector('#seqsig').scrollIntoView({behavior: 'smooth'});">Calculate</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="interface-modal-table" role="dialog">
    <div class="modal-dialog modal-wide">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select interfaces from the table</h4>
            </div>

            <div class="modal-body">
                <div class="col-md-12">
                    <table id="table-interface" class="display">
                    </table>
                </div>
                <div class="clearfix"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="pdb-modal-table" role="dialog">
    <!-- <div class="modal-dialog modal-wide" style="width: 800px"> -->
    <div class="modal-dialog modal-wide" style="width: 100%">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select PDBs from the table</h4>
            </div>

            <div class="modal-body">
                <div class="col-md-12">
                    <table id="table-pdb" class="display" width="100%">
                    </table>
                </div>
                <div class="clearfix"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<div id="raw-data">
    <h2>Raw Data</h2>
    <table id="table-data" class="display">
        <thead>
            <tr>
                <th>int_ty</th>
                <th>PDB</th>
                <th>R AA</th>
                <th>R GN</th>
                <th>R Pos</th>
                <th>S AA</th>
                <th>S Pos</th>
            </tr>
        </thead>
    </table>
</div>

<div id="svg-container">
    <h2>Interaction Interface</h2>
</div>

<div id="seqsig">
    <h2>Sequence Signature</h2>
</div>

{% endblock %}

{% block addon_js %}
<script type="text/javascript">
    const interactions = {{ interactions | safe}};
    const interactions_metadata = {{ interactions_metadata | safe}};
    const ps = {{ ps | safe}};
    const rs = {{ rs | safe}};
    let pdb_sel = [];

    // Global Variable
    let data;
    let svg;
    let xScale;
    let yScale;
    let xAxis;
    let yAxis;
    let xAxisGrid;
    let yAxisGrid;
    let pdbScale;
    let sigScale;
    let colScale;
    let tooltip;

    const select_by_value = function (selection, value) {
        let ret_sel = []
        for (let index = 0; index < selection.length; index++) {
            ret_sel.push(selection[index][value]);
        };
        return ret_sel;
    };
</script>
<script src="{% static 'home/js/d3.v5.7.min.js' %}"></script>
<script src="{% static 'home/js/d3.tip.v4comp.js' %}"></script>
<script src="{% static 'home/js/d3-legend.min.js' %}"></script>
<script src="{% static 'home/js/lodash.min.js' %}"></script>
<script src="{% static 'home/js/chroma.min.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'home/js/dataTables.select.min.js' %}"></script>
<script src="{% static 'home/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'home/js/signprotmat.js' %}"></script>
<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        const table = $('#table-interface').DataTable({
            dom: 'Bfrtip',
            data: interactions_metadata,
            columnDefs: [
                {
                    data: null,
                    targets: 0,
                    defaultContent: '',
                    orderable: false,
                    className: 'select-checkbox',
                }, {
                    data: 'pdb_id',
                    title: 'PDB',
                    targets: 1,
                }],
            select: {
                style: 'os',
            },
            paging: false,
            buttons: [
                {
                    text: 'Select all',
                    action: function () {
                        table.rows().select();
                    }
                },
                {
                    text: 'Select none',
                    action: function () {
                        table.rows().deselect();
                    }
                },
            ]
        });

        table
            .on('select', function (e, dt, type, indexes) {
                const row_count = table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#interface-count').text(row_count + ' interfaces selected.');
                } else {
                    $('#interface-count').text(row_count + ' interface selected.');
                }
            })
            .on('deselect', function (e, dt, type, indexes) {
                const row_count = table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#interface-count').text(row_count + ' interfaces selected.');
                } else {
                    $('#interface-count').text(row_count + ' interface selected.');
                }
            });

        // Default: Select all rows on page load
        table.rows().select();
        pdb_sel = select_by_value(table.rows({ selected: true }).data(), 'pdb_id');

        $('#interface-modal-table').on('hidden.bs.modal', function (e) {
            const selection = table.rows({ selected: true }).data();
            pdb_sel = select_by_value(selection, 'pdb_id')

            $('.svg-content').remove();
            data = signprotmat.data.dataTransformationWrapper(interactions, keys, pdb_sel);
            svg = signprotmat.d3.setup();
            xScale = signprotmat.d3.xScale(data.transformed);
            yScale = signprotmat.d3.yScale(data.transformed);
            xAxis = signprotmat.d3.xAxis(xScale);
            yAxis = signprotmat.d3.yAxis(yScale);
            xAxisGrid = signprotmat.d3.xAxisGrid(xScale, yScale);
            yAxisGrid = signprotmat.d3.yAxisGrid(xScale, yScale);
            pdbScale = signprotmat.d3.pdbScale(data.transformed);
            sigScale = signprotmat.d3.sigScale(data.transformed);
            colScale = signprotmat.d3.colScale(data.inttypes);
            tooltip = signprotmat.d3.tooltip(svg);
            signprotmat.d3.renderData(
                svg,
                data,
                xScale,
                yScale,
                xAxis,
                yAxis,
                xAxisGrid,
                yAxisGrid,
                colScale,
                pdbScale,
                sigScale,
                tooltip
            );

            interface_data_table.clear();
            interface_data_table.rows.add(data.transformed);
            interface_data_table.draw();

            const row_selection = pdb_table.rows({ selected: true }).data();
            const xvals = xScale.domain();
            const prids = select_by_value(row_selection, 'rec_id');

            receptor_data = signprotmat.data.get_additional_receptors(rs, xvals, prids)
            signprotmat.d3.addReceptor(receptor_data, data, svg);

        });

        let keys = [
            "rec_chain",
            "rec_aa",
            "rec_pos",
            "rec_gn",
            "sig_chain",
            "sig_aa",
            // "sig_pos",
            "sig_gn",
            "int_ty",
            "pdb_id"
        ];

        data = signprotmat.data.dataTransformationWrapper(interactions, keys, pdb_sel);
        svg = signprotmat.d3.setup();
        xScale = signprotmat.d3.xScale(data.transformed);
        yScale = signprotmat.d3.yScale(data.transformed);
        xAxis = signprotmat.d3.xAxis(xScale);
        yAxis = signprotmat.d3.yAxis(yScale);
        xAxisGrid = signprotmat.d3.xAxisGrid(xScale, yScale);
        yAxisGrid = signprotmat.d3.yAxisGrid(xScale, yScale);
        pdbScale = signprotmat.d3.pdbScale(data.transformed);
        sigScale = signprotmat.d3.sigScale(data.transformed);
        colScale = signprotmat.d3.colScale(data.inttypes);
        tooltip = signprotmat.d3.tooltip(svg);
        signprotmat.d3.renderData(
            svg,
            data,
            xScale,
            yScale,
            xAxis,
            yAxis,
            xAxisGrid,
            yAxisGrid,
            colScale,
            pdbScale,
            sigScale,
            tooltip
        );

        // PDB TABLE MODAL
        const pdb_table = $('#table-pdb').DataTable({
            dom: 'Bfrtip',
            data: ps,
            scrollX: true,
            columnDefs: [
                {
                    data: null,
                    targets: 0,
                    defaultContent: '',
                    orderable: false,
                    className: 'select-checkbox',
                }, {
                    data: 'protein_class',
                    title: 'Class',
                    targets: 1,
                }, {
                    data: 'protein_family',
                    title: 'Family',
                    targets: 2,
                }, {
                    data: 'name',
                    title: 'Name',
                    targets: 3,
                }, {
                    data: 'pdb_id',
                    title: 'PDB',
                    targets: 4,
                }, {
                    data: 'rec_id',
                    title: 'receptor id',
                    targets: 5,
                }, {
                    data: 'ligand',
                    title: 'Ligand',
                    targets: 6,
                }],
            select: {
                style: 'os',
            },
            paging: true,
            buttons: [
                {
                    text: 'Select all',
                    action: function () {
                        pdb_table.rows().select();
                    }
                },
                {
                    text: 'Select none',
                    action: function () {
                        pdb_table.rows().deselect();
                    }
                },
            ]
        });


        pdb_table
            .on('select', function (e, dt, type, indexes) {
                const row_count = pdb_table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#pdb-count').text(row_count + ' PDBs selected.')
                } else {
                    $('#pdb-count').text(row_count + ' PDB selected.')
                }
            })
            .on('deselect', function (e, dt, type, indexes) {
                const row_count = pdb_table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#pdb-count').text(row_count + ' PDBs selected.')
                } else {
                    $('#pdb-count').text(row_count + ' PDB selected.')
                }
            });

        $('#pdb-modal-table').on('hidden.bs.modal', function (e) {
            const row_selection = pdb_table.rows({ selected: true }).data();
            const xvals = xScale.domain();
            const prids = select_by_value(row_selection, 'rec_id');

            receptor_data = signprotmat.data.get_additional_receptors(rs, xvals, prids)
            signprotmat.d3.addReceptor(receptor_data, data, svg);
        });

        let interface_data_table = $('#table-data').DataTable({
            data: data.transformed,
            columns: [
                { data: 'int_ty' },
                { data: 'pdb_id' },
                { data: 'rec_aa' },
                { data: 'rec_gn' },
                { data: 'rec_pos' },
                { data: 'sig_aa' },
                { data: 'sig_gn' }
            ]
        });

        // https://www.datatables.net/examples/api/tabs_and_scrolling.html
        $(document).on('shown.bs.modal', function (e) {
            console.log('this');
            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
        });

    });


</script>

{% endblock %}