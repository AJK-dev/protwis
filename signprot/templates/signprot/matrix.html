{% extends "home/base.html" %}
{% load staticfiles %}

{% block addon_css %}
<link href="{% static 'home/css/signprotmat.css' %}" rel="stylesheet">
<link href="{% static 'home/css/jquery.dataTables.min.css' %}" rel="stylesheet">
<link href="{% static 'home/css/select.dataTables.min.css' %}" rel="stylesheet">
<link href="{% static 'home/css/buttons.dataTables.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<h1 class="page-header">GPCR - Signal Protein Interaction Matrix</h1>
<p>
    Display the interaction between one or multiple GPCR/G-protein complex interfaces.
</p>

<div class="row">
    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">Interface(s)</h3>
            </div>

            <div class="panel-body">
                <h5><span id='interface-count' class="crystal-count">0 interfaces selected.</span></h5>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#interface-modal-table">Select Interface</button>
            </div>

        </div>
    </div>

    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">Add additional PDB(s)</h3>
            </div>

            <div class="panel-body">
                <h5><span id='pdb-count' class="crystal-count">0 PDBs selected.</span></h5>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#pdb-modal-table">Add PDB</button>
            </div>

        </div>
    </div>

    <div class="col-md-3">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h3 class="panel-title">TEST</h3>
            </div>

            <div class="panel-body">
                <button type="button" class="btn btn-primary" onclick="signprotmat.d3.addReceptor(test_pdb_data, data, svg)">Add TEST PDB</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="interface-modal-table" role="dialog">
    <div class="modal-dialog modal-wide">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select interfaces from the table</h4>
            </div>

            <div class="modal-body">
                <div class="col-md-12">
                    <table id="table-interface" class="display">
                    </table>
                </div>
                <div class="clearfix"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="pdb-modal-table" role="dialog">
    <div class="modal-dialog modal-wide">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select PDBs from the table</h4>
            </div>

            <div class="modal-body">
                <div class="col-md-12">
                    <table id="table-pdb" class="display">
                    </table>
                </div>
                <div class="clearfix"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<table id="table-data" class="display">
    <thead>
        <tr>
            <th>int_ty</th>
            <th>PDB</th>
            <th>R AA</th>
            <th>R GN</th>
            <th>R Pos</th>
            <th>S AA</th>
            <th>S Pos</th>
        </tr>
    </thead>
</table>

{% endblock %}

{% block addon_js %}
<script type="text/javascript">
    const interactions = {{ interactions | safe}};
    const interactions_metadata = {{ interactions_metadata | safe}};
    let pdb_sel = [];

    // Global Variable
    let data;
    let svg;
    let xScale;
    let yScale;
    let xAxis;
    let yAxis;
    let xAxisGrid;
    let yAxisGrid;
    let pdbScale;
    let sigScale;
    let colScale;
    let tooltip;

    let test_pdb_data = [
            {
                'pdb_id': 'XYZA',
                'rec_gn': '4.39x40',
                'rec_aa': 'A',
            },
            {
                'pdb_id': 'XYZA',
                'rec_gn': '4.40x40',
                'rec_aa': 'B',
            },
            {
                'pdb_id': 'XYZA',
                'rec_gn': '4.40x41',
                'rec_aa': 'C',
            },
            {
                'pdb_id': 'XYZA',
                'rec_gn': '5.57x57',
                'rec_aa': 'D',
            },
        ]

    const whichPdb = function (selection) {
        let pdb_sel = []
        for (let index = 0; index < selection.length; index++) {
            pdb_sel.push(selection[index].pdb_id);
        };
        return pdb_sel;
    };
</script>
<script src="{% static 'home/js/d3.v5.7.min.js' %}"></script>
<script src="{% static 'home/js/d3.tip.v4comp.js' %}"></script>
<script src="{% static 'home/js/d3-legend.min.js' %}"></script>
<script src="{% static 'home/js/lodash.min.js' %}"></script>
<script src="{% static 'home/js/chroma.min.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'home/js/dataTables.select.min.js' %}"></script>
<script src="{% static 'home/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'home/js/signprotmat.js' %}"></script>
<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        const table = $('#table-interface').DataTable({
            dom: 'Bfrtip',
            data: interactions_metadata,
            columnDefs: [
                {
                    data: null,
                    targets: 0,
                    defaultContent: '',
                    orderable: false,
                    className: 'select-checkbox',
                }, {
                    data: 'pdb_id',
                    title: 'PDB',
                    targets: 1,
                }],
            select: {
                style: 'os',
            },
            paging: false,
            buttons: [
                {
                    text: 'Select all',
                    action: function () {
                        table.rows().select();
                    }
                },
                {
                    text: 'Select none',
                    action: function () {
                        table.rows().deselect();
                    }
                },
            ]
        });

        table
            .on('select', function (e, dt, type, indexes) {
                const row_count = table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#interface-count').text(row_count + ' interfaces selected.');
                } else {
                    $('#interface-count').text(row_count + ' interface selected.');
                }
            })
            .on('deselect', function (e, dt, type, indexes) {
                const row_count = table.rows({ selected: true }).count()
                if (row_count >= 2 || row_count === 0) {
                    $('#interface-count').text(row_count + ' interfaces selected.');
                } else {
                    $('#interface-count').text(row_count + ' interface selected.');
                }
            });

        // Default: Select all rows on page load
        table.rows().select();
        pdb_sel = whichPdb(table.rows({ selected: true }).data());

        // https://www.datatables.net/examples/api/tabs_and_scrolling.html
        $('#interface-modal-table').on('shown.bs.modal', function (e) {
            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
        });

        $('#interface-modal-table').on('hidden.bs.modal', function (e) {
            const selection = table.rows({ selected: true }).data();
            pdb_sel = whichPdb(selection)

            $('.svg-container').remove();
            data = signprotmat.data.dataTransformationWrapper(interactions, keys, pdb_sel);
            svg = signprotmat.d3.setup();
            xScale = signprotmat.d3.xScale(data.transformed);
            yScale = signprotmat.d3.yScale(data.transformed);
            xAxis = signprotmat.d3.xAxis(xScale);
            yAxis = signprotmat.d3.yAxis(yScale);
            xAxisGrid = signprotmat.d3.xAxisGrid(xScale, yScale);
            yAxisGrid = signprotmat.d3.yAxisGrid(xScale, yScale);
            pdbScale = signprotmat.d3.pdbScale(data.transformed);
            sigScale = signprotmat.d3.sigScale(data.transformed);
            colScale = signprotmat.d3.colScale(data.inttypes);
            tooltip = signprotmat.d3.tooltip(svg);
            signprotmat.d3.renderData(
                svg,
                data,
                xScale,
                yScale,
                xAxis,
                yAxis,
                xAxisGrid,
                yAxisGrid,
                colScale,
                pdbScale,
                sigScale,
                tooltip
            );

            interface_data_table.clear();
            interface_data_table.rows.add(data.transformed);
            interface_data_table.draw();

        });

        let keys = [
            "rec_chain",
            "rec_aa",
            "rec_pos",
            "rec_gn",
            "sig_chain",
            "sig_aa",
            // "sig_pos",
            "sig_gn",
            "int_ty",
            "pdb_id"
        ];

        data = signprotmat.data.dataTransformationWrapper(interactions, keys, pdb_sel);
        svg = signprotmat.d3.setup();
        xScale = signprotmat.d3.xScale(data.transformed);
        yScale = signprotmat.d3.yScale(data.transformed);
        xAxis = signprotmat.d3.xAxis(xScale);
        yAxis = signprotmat.d3.yAxis(yScale);
        xAxisGrid = signprotmat.d3.xAxisGrid(xScale, yScale);
        yAxisGrid = signprotmat.d3.yAxisGrid(xScale, yScale);
        pdbScale = signprotmat.d3.pdbScale(data.transformed);
        sigScale = signprotmat.d3.sigScale(data.transformed);
        colScale = signprotmat.d3.colScale(data.inttypes);
        tooltip = signprotmat.d3.tooltip(svg);
        signprotmat.d3.renderData(
            svg,
            data,
            xScale,
            yScale,
            xAxis,
            yAxis,
            xAxisGrid,
            yAxisGrid,
            colScale,
            pdbScale,
            sigScale,
            tooltip
        );

        let interface_data_table = $('#table-data').DataTable({
            data: data.transformed,
            columns: [
                { data: 'int_ty' },
                { data: 'pdb_id' },
                { data: 'rec_aa' },
                { data: 'rec_gn' },
                { data: 'rec_pos' },
                { data: 'sig_aa' },
                { data: 'sig_gn' }
            ]
        });
    });

</script>

{% endblock %}