{% extends "home/base.html" %}
{% load staticfiles %}

{% block content %}

    
      <ul class="nav nav-tabs" id='mode_nav'>
  			<li class="active">
                  <a href="#single-crystal-tab" data-toggle="tab">Single structure</a>
  			</li>
  			<li>
                  <a href="#single-crystal-group-tab" data-toggle="tab">Single group of structures</a>
  			</li>
  			<li>
                  <a href="#two-crystal-groups-tab" data-toggle="tab">Two groups of structures</a>
  			</li>
		  </ul>

        <div class="tab-content clearfix">
            <!-- BEGIN SINGLE CRYSTAL TAB -->
		    <div class="tab-pane active" id="single-crystal-tab">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="page-header">Single structure interactions</h1>
                        <p>Display interaction heatmap for a single structure. Choose a PDB and options below.</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">PDBs</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="interactions-input" value="[]" />
                                <input class="crystal-pdb" type="hidden" value="[]" />
                                <h5><span class="crystal-count">No structure selected.</span></h5>
                                {# <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-pdb-modal">Select PDB</button><br><br> #}
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-pdb-modal-table">Select PDB</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="panel panel-default segments-panel">
                            <div class="panel-heading">
                                <h3 class="panel-title">Segments</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="segments-input" value="[]" />
                                <h5>Helices</h5>
                                <div class="btn-group buttons-helices">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM1">TM1</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM2">TM2</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM3">TM3</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM4">TM4</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM5">TM5</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM6">TM6</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM7">TM7</button>
                                  <button type="button" class="btn btn-primary" data-segment="H8">H8</button>
                                </div>
                                <h5>Loops</h5>
                                <div class="btn-group buttons-loops">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL1">ICL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL1">ECL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL2">ICL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL2">ECL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL3">ICL3</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL3">ECL3</button>
                                </div>
                                <h5>Termini</h5>
                                <div class="btn-group buttons-termini">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="N-term">N-term</button>
                                  <button type="button" class="btn btn-primary" data-segment="C-term">C-term</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="btn btn-success btn-lg pull-right go-button"><span>Go</span></div>
                    </div>
                </div>
                <ul class="nav nav-tabs">
                  <li class="active"><a href="#single-matrix-tab" data-toggle="tab">Matrix</a></li>
                  <li><a href="#single-flareplot-tab" data-toggle="tab" id="single-flareplot-tab-link">Flareplot</a></li>
                  <li><a href="#single-schematic-con-tab" data-toggle="tab" id="single-schematic-con-tab-link">2D Schematic (Con)</a></li>
                  <li><a href="#single-schematic-non-tab" data-toggle="tab" id="single-schematic-non-tab-link">2D Schematic (Non)</a></li>
                  <li><a href="#single-table-tab" data-toggle="tab" id="single-table-tab-link">Browser</a></li>
                  <li><a href="#single-NGL-tab" data-toggle="tab" id="single-NGL-link">NGL</a></li>
                </ul>
                <div class="row">
                  <div class="tab-content">
                      <div class="col-md-12 tab-pane active" id="single-matrix-tab">
                           <div class="panel panel-default no-top-border">
                              <div class="panel-heading">
                                  <h3 class="panel-title pull-left">Interactions</h3>
                                  <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                  <div class="clearfix"></div>
                              </div>
                              <div class="panel-body">
                                  <div class="heatmap-container">
                                      <div class="heatmap-legend"></div>
                                      <svg class="heatmap" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin"></svg>
                                  </div>
                              </div>
                           </div>
                      </div>

                      <div class="col-md-12 tab-pane" id="single-table-tab">
                      </div>

                      <div class="col-md-12 tab-pane" id="single-flareplot-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">Flareplot</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="flareplot-container">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-schematic-con-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-con-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-schematic-non-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic Non</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-non-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-NGL-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">NGL</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="ngl-container" id="ngl-single" style="margin: auto; width:100%; height:1000px;">
                                </div>
                            </div>
                         </div>

                      </div>

                    </div>
                </div>


            </div>
            <!-- END SINGLE CRYSTAL TAB -->
            <!-- BEGIN SINGLE CRYSTAL GROUP TAB -->
            <div class="tab-pane" id="single-crystal-group-tab">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="page-header">Single group of structures interactions</h1>
                        <p>Display similarity heatmap for a group of structures. Choose PDBs and options below.</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">PDBs</h3>
                            </div>
                            <div class="panel-body">
                                <input class="crystal-pdb" type="hidden" value="[]" />
                                <h5><span class="crystal-count">0</span> structure(s) selected.</h5>
                                {# <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-group-pdbs-modal">Select PDBs</button> #}
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-group-pdbs-modal-table">Select PDBs</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="panel panel-default segments-panel">
                            <div class="panel-heading">
                                <h3 class="panel-title">Segments</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="segments-input" value="[]" />
                                <h5>Helices</h5>
                                <div class="btn-group buttons-helices">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM1">TM1</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM2">TM2</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM3">TM3</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM4">TM4</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM5">TM5</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM6">TM6</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM7">TM7</button>
                                  <button type="button" class="btn btn-primary" data-segment="H8">H8</button>
                                </div>
                                <h5>Loops</h5>
                                <div class="btn-group buttons-loops">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL1">ICL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL1">ECL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL2">ICL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL2">ECL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL3">ICL3</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL3">ECL3</button>
                                </div>
                                <h5>Termini</h5>
                                <div class="btn-group buttons-termini">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="N-term">N-term</button>
                                  <button type="button" class="btn btn-primary" data-segment="C-term">C-term</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-default interactions-panel">
                            <div class="panel-heading">
                                <h3 class="panel-title">Interactions</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="interactions-input" value="[]" />
                                <h5>Types</h5>
                                <div class="btn-group buttons-helices">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="polarinteraction polarsidechainsidechaininteraction polarbackbonesidechaininteraction">Polar</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="aromaticinteraction facetoedgeinteraction facetofaceinteraction picationinteraction">Arom.</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="hydrophobicinteraction">Hydro.</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="vanderwaalsinteraction">VDW</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-offset-3 col-md-1">
                        <div class="btn btn-success btn-lg pull-right go-button">Go</div>
                    </div>
                </div>


                <ul class="nav nav-tabs">
                  <li class="active"><a href="#single-group-matrix-tab" data-toggle="tab">Matrix</a></li>
                  <li><a href="#single-group-flareplot-tab" data-toggle="tab" id="single-group-flareplot-tab-link">Flareplot</a></li>
                  <li><a href="#single-group-schematic-con-tab" data-toggle="tab" id="single-group-schematic-con-tab-link">2D Schematic (Con)</a></li>
                  <li><a href="#single-group-schematic-non-tab" data-toggle="tab" id="single-group-schematic-non-tab-link">2D Schematic (Non)</a></li>
                  <li><a href="#single-group-table-tab" data-toggle="tab" id="single-group-table-tab-link">Browser</a></li>
                  <li><a href="#single-group-NGL-tab" data-toggle="tab" id="single-group-NGL-link">NGL</a></li>
                </ul>
                <div class="row">
                  <div class="tab-content">
                      <div class="col-md-12 tab-pane active" id="single-group-matrix-tab">
                           <div class="panel panel-default no-top-border">
                              <div class="panel-heading">
                                  <h3 class="panel-title pull-left">Interactions</h3>
                                  <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                  <div class="clearfix"></div>
                              </div>
                              <div class="panel-body">
                                  <div class="heatmap-container">
                                      <div class="heatmap-legend"></div>
                                      <svg class="heatmap" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin"></svg>
                                  </div>
                              </div>
                           </div>
                      </div>

                      <div class="col-md-12 tab-pane" id="single-group-table-tab">
                      </div>

                      <div class="col-md-12 tab-pane" id="single-group-flareplot-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">Flareplot</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="flareplot-container">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-group-schematic-con-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-con-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-group-schematic-non-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic Non</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-non-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="single-group-NGL-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">NGL</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="ngl-container" id="ngl-single" style="margin: auto; width:100%; height:1000px;">
                                </div>
                            </div>
                         </div>

                      </div>

                    </div>
                </div>

            </div>
            <!-- END SINGLE CRYSTAL GROUP TAB -->
            <!-- BEGIN TWO CRYSTAL GROUPS TAB -->
            <div class="tab-pane" id="two-crystal-groups-tab">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="page-header">Two groups of structures interactions</h1>
                        <p>Display similarity/dissimilarity heatmap for two groups of structures. Choose PDBs and options below.</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">PDBs</h3>
                            </div>
                            <div class="panel-body">
                                <input class="crystal-group-1-pdbs" type="hidden" value="[]" />
                                <input class="crystal-group-2-pdbs" type="hidden" value="[]" />
                                <h5><span class="crystal-count-1">0</span> structure(s) selected.</h5>
                                {# <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#two-crystal-group-pdbs-modal-1">Select PDBs</button> #}
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#two-crystal-group-pdbs-modal-1-table">Select PDBs</button>
                                <h5><span class="crystal-count-2">0</span> structure(s) selected.</h5>
                                {# <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#two-crystal-group-pdbs-modal-2">Select PDBs</button> #}
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#two-crystal-group-pdbs-modal-2-table">Select PDBs</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="panel panel-default segments-panel">
                            <div class="panel-heading">
                                <h3 class="panel-title">Segments</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="segments-input" value="[]" />
                                <h5>Helices</h5>
                                <div class="btn-group buttons-helices">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM1">TM1</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM2">TM2</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM3">TM3</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM4">TM4</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM5">TM5</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM6">TM6</button>
                                  <button type="button" class="btn btn-primary" data-segment="TM7">TM7</button>
                                  <button type="button" class="btn btn-primary" data-segment="H8">H8</button>
                                </div>
                                <h5>Loops</h5>
                                <div class="btn-group buttons-loops">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL1">ICL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL1">ECL1</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL2">ICL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL2">ECL2</button>
                                  <button type="button" class="btn btn-primary" data-segment="ICL3">ICL3</button>
                                  <button type="button" class="btn btn-primary" data-segment="ECL3">ECL3</button>
                                </div>
                                <h5>Termini</h5>
                                <div class="btn-group buttons-termini">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-segment="N-term">N-term</button>
                                  <button type="button" class="btn btn-primary" data-segment="C-term">C-term</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-default interactions-panel">
                            <div class="panel-heading">
                                <h3 class="panel-title">Interactions</h3>
                            </div>
                            <div class="panel-body">
                                <input type="hidden" class="interactions-input" value="[]" />
                                <h5>Types</h5>
                                <div class="btn-group buttons-helices">
                                  <button type="button" class="btn btn-primary all-button">All</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="polarinteraction polarsidechainsidechaininteraction polarbackbonesidechaininteraction">Polar</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="aromaticinteraction facetoedgeinteraction facetofaceinteraction picationinteraction">Arom.</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="hydrophobicinteraction">Hydro.</button>
                                  <button type="button" class="btn btn-primary" data-interaction-type="vanderwaalsinteraction">VDW</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-offset-3 col-md-1">
                        <div class="btn btn-success btn-lg pull-right go-button">Go</div>
                    </div>
                </div>


                <ul class="nav nav-tabs">
                  <li class="active"><a href="#two-groups-matrix-tab" data-toggle="tab">Matrix</a></li>
                  <li><a href="#two-groups-flareplot-tab" data-toggle="tab" id="two-groups-flareplot-tab-link">Flareplot</a></li>
                  <li><a href="#two-groups-schematic-con-tab" data-toggle="tab" id="two-groups-schematic-con-tab-link">2D Schematic (Con)</a></li>
                  <li><a href="#two-groups-schematic-non-tab" data-toggle="tab" id="two-groups-schematic-non-tab-link">2D Schematic (Non)</a></li>
                  <li><a href="#two-groups-table-tab" data-toggle="tab" id="two-groups-table-tab-link">Browser</a></li>
                  <li><a href="#two-groups-NGL-tab" data-toggle="tab" id="two-groups-NGL-link">NGL</a></li>
                </ul>
                <div class="row">
                  <div class="tab-content">
                      <div class="col-md-12 tab-pane active" id="two-groups-matrix-tab">
                           <div class="panel panel-default no-top-border">
                              <div class="panel-heading">
                                  <h3 class="panel-title pull-left">Interactions</h3>
                                  <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                  <div class="clearfix"></div>
                              </div>
                              <div class="panel-body">
                                  <div class="heatmap-container">
                                      <div class="heatmap-legend"></div>
                                      <svg class="heatmap" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin"></svg>
                                  </div>
                              </div>
                           </div>
                      </div>

                      <div class="col-md-12 tab-pane" id="two-groups-table-tab">
                      </div>

                      <div class="col-md-12 tab-pane" id="two-groups-flareplot-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">Flareplot</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="flareplot-container">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="two-groups-schematic-con-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-con-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="two-groups-schematic-non-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">2D schematic Non</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="schematic-non-container" style="margin: auto; display: block">
                                </div>
                            </div>
                         </div>

                      </div>

                      <div class="col-md-12 tab-pane" id="two-groups-NGL-tab">

                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title pull-left">NGL</h3>
                                <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="ngl-container" id="ngl-single" style="margin: auto; width:100%; height:1000px;">
                                </div>
                            </div>
                         </div>

                      </div>

                    </div>
                </div>

            </div>
            <!-- END TWO CRYSTAL GROUPS TAB -->
        </div>

                      

    <!-- BEGIN SINGLE CRYSTAL PDB CHOOSER MODAL -->
    <div class="modal fade" id="single-crystal-pdb-modal-table" role="dialog">
        <div class="modal-dialog modal-wide">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a group of structures from table</h4>
                </div>
                <div class="modal-body">
                      <div class="col-md-12">
                        <div class="tableview"></div>
                        </div>
                      <div class="clearfix"></div>
               </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END SINGLE CRYSTAL PDB CHOOSER MODAL -->

    <!-- BEGIN SINGLE CRYSTAL GROUP PDBS CHOOSER MODAL -->
    <div class="modal fade" id="single-crystal-group-pdbs-modal-table" role="dialog">
        <div class="modal-dialog modal-wide">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a group of structures</h4>
                </div>
                <div class="modal-body">
                      <div class="col-md-12">
                        <span id="single-crystal-group-pdbs-modal-text">0 structure(s) selected</span><br>
                        <div class="tableview"></div>
                      </div>
               </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END SINGLE CRYSTAL GROUP PDBS CHOOSER MODAL -->

    <!-- BEGIN TWO CRYSTAL GROUP 1 PDBS CHOOSER MODAL (GROUP 1) -->
    <div class="modal fade" id="two-crystal-group-pdbs-modal-1-table" role="dialog">
        <div class="modal-dialog modal-wide">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a group of structures</h4>
                </div>
                <div class="modal-body">
                        <span id="two-crystal-group-pdbs-modal-1-text">0 structure(s) selected</span><br>
                        <div class="tableview group-number-1" group-number="1"></div>
               </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- END TWO CRYSTAL GROUP 1 PDBS CHOOSER MODAL (GROUP 1) -->

    <!-- BEGIN TWO CRYSTAL GROUP PDBS CHOOSER MODAL (GROUP 2) -->
    <div class="modal fade" id="two-crystal-group-pdbs-modal-2-table" role="dialog">
        <div class="modal-dialog modal-wide">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a group of structures</h4>
                </div>
                <div class="modal-body">
                        <span id="two-crystal-group-pdbs-modal-2-text">0 structure(s) selected</span><br>
                        <div class="tableview group-number-2" group-number="2"></div>
               </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END TWO CRYSTAL GROUP PDBS CHOOSER MODAL (GROUP 2) -->
{% endblock %}
{% block addon_js %}
    <script type="text/javascript" src="{% static 'home/js/snap.svg-min.js' %}"> </script>
    <script type="text/javascript" src="{% static 'home/js/typeahead.bundle.min.js' %}"> </script>

    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/selection.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/jquery.tablesorter.js' %}"></script> 
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        window.zoomHeatmap = {};

        function toggleFullScreen(fullScreenElement) {
            if (!document.mozFullScreen && !document.webkitFullScreen) {
                if (fullScreenElement.mozRequestFullScreen) {
                    fullScreenElement.mozRequestFullScreen();
                } else {
                    fullScreenElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
                }
            } else {
                if (document.mozCancelFullScreen) {
                  document.mozCancelFullScreen();
                } else {
                  document.webkitCancelFullScreen();
                }
            }
        }

        function hidePopovers() {
            $('.popover').each(function(){
                $(this).popover('hide');
            });
        }

        function HSVtoRGB(h, s, v) {
            var r, g, b, i, f, p, q, t;
            if (arguments.length === 1) {
                s = h.s, v = h.v, h = h.h;
            }
            i = Math.floor(h * 6);
            f = h * 6 - i;
            p = v * (1 - s);
            q = v * (1 - f * s);
            t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break;
                case 1: r = q, g = v, b = p; break;
                case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break;
                case 4: r = t, g = p, b = v; break;
                case 5: r = v, g = p, b = q; break;
            }
            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }

        function rgb2hex(r,g,b) {
            r = r.toString(16);
            g = g.toString(16);
            b = b.toString(16);

            if (r.length == 1)
                r = '0' + r;

            if (g.length == 1)
                g = '0' + g;

            if (b.length == 1)
                b = '0' + b;

            return '#' + r + g + b;
        }

        function getInteractionStrength(i) {
            switch (i) { 
                case getFriendlyInteractionName('polarsidechainsidechaininteraction'):
                case getFriendlyInteractionName('polarbackbonesidechaininteraction'):
                case'polarsidechainsidechaininteraction':
                case'polarbackbonesidechaininteraction':
                    return 4;
                case getFriendlyInteractionName('facetofaceinteraction'):
                case getFriendlyInteractionName('facetoedgeinteraction'):
                case getFriendlyInteractionName('picationinteraction'):
                case'facetofaceinteraction':
                case'facetoedgeinteraction':
                case'picationinteraction':
                    return 3;
                case getFriendlyInteractionName('hydrophobicinteraction'):
                case'hydrophobicinteraction':
                    return 2;
                case getFriendlyInteractionName('vanderwaalsinteraction'):
                case'vanderwaalsinteraction':
                    return 1;
                default:
                    return 0;
            }
        }


        function getStrongestInteractionType(interactions) {

            if ($.inArray('polarsidechainsidechaininteraction', interactions) > -1)
                return 'polarsidechainsidechaininteraction';

            if ($.inArray('polarbackbonesidechaininteraction', interactions) > -1)
                return 'polarbackbonesidechaininteraction';

            if ($.inArray('facetofaceinteraction', interactions) > -1)
                return 'facetofaceinteraction';

            if ($.inArray('facetoedgeinteraction', interactions) > -1)
                return 'facetoedgeinteraction';

            if ($.inArray('picationinteraction', interactions) > -1)
                return 'picationinteraction';

            if ($.inArray('hydrophobicinteraction', interactions) > -1)
                return 'hydrophobicinteraction';

            if ($.inArray('vanderwaalsinteraction', interactions) > -1)
                return 'vanderwaalsinteraction';

            return 'undefined';
        }

        function getStrongestInteractionTypeFromPdbObject(obj) {

            var interactions = [];

            for (var key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    var strongestInteraction = getStrongestInteractionType(obj[key]);
                    interactions.push(strongestInteraction);
                }
            }

            return getStrongestInteractionType(interactions);
        }

        function getInteractionTypesFromPdbObject(obj) {

            var interactions = new Set();
            for (var key in obj) {
              Object.keys(obj[key]).forEach(function(k,index) {
                        interactions.add(obj[key][k]);
              });
                // if (Object.prototype.hasOwnProperty.call(obj, key)) {
                //     for (var k in obj[key])
                //         interactions.add(obj[key][k]);
                // }
            }

            // Sort according to strength
            interactions = Array.from(interactions);
            interactions.sort(function (i1, i2) {
                return  getInteractionStrength(i1) - getInteractionStrength(i2);
            });

            return interactions;
        }


        function getInteractionColor(interaction) {

            var r, g, b;

            switch (interaction) {
                case 'polarsidechainsidechaininteraction':
                case 'polarbackbonesidechaininteraction':
                case getFriendlyInteractionName('polarsidechainsidechaininteraction'):
                case getFriendlyInteractionName('polarbackbonesidechaininteraction'):
                    r = 254; g = 0; b = 16;
                    break;
                case 'facetofaceinteraction':
                case 'facetoedgeinteraction':
                case 'picationinteraction':
                case getFriendlyInteractionName('facetofaceinteraction'):
                case getFriendlyInteractionName('facetoedgeinteraction'):
                case getFriendlyInteractionName('picationinteraction'):
                    r = 94; g = 241; b = 242;
                    break;
                case 'hydrophobicinteraction':
                case getFriendlyInteractionName('hydrophobicinteraction'):
                    r = 0; g = 117; b = 220;
                    break;
                case 'vanderwaalsinteraction':
                case getFriendlyInteractionName('vanderwaalsinteraction'):
                    r = 89; g = 252; b = 197;
                    break;
                default:
                    r = 0; g = 0; b = 0;
            }

            return { r: r, g: g, b: b };
        }

        function getFriendlyInteractionName(interaction) {
            switch (interaction) {
                case 'polarsidechainsidechaininteraction':
                case 'polarbackbonesidechaininteraction':
                    return 'Polar';
                case 'facetofaceinteraction':
                case 'facetoedgeinteraction':
                case 'picationinteraction':
                    return 'Aromatic';
                case 'hydrophobicinteraction':
                    return 'Hydrophobic';
                case 'vanderwaalsinteraction':
                    return 'Van der Waals';
                default:
                    return 'Unknown';
            }
        }

        function getSegmentColor(segmentName) {
            var r, g, b;

            switch (segmentName) {
                case 'N-term':
                case 'C-term':
                    r = 190; g = 190; b = 190;
                    //r = 255; g = 150; b = 150;
                    break;
                case 'TM1':
                case 'TM2':
                case 'TM3':
                case 'TM4':
                case 'TM5':
                case 'TM6':
                case 'TM7':
                case 'H8':
                    r = 230; g = 230; b = 230;
                    //r = 150; g = 255; b = 150;
                    break;
                case 'ECL1':
                case 'ECL2':
                case 'ECL3':
                    r = 190; g = 190; b = 190;
                    //r = 150; g = 150; b = 255;
                    break;
                case 'ICL1':
                case 'ICL2':
                case 'ICL3':
                    r = 190; g = 190; b = 190;
                    //r = 150; g = 150; b = 255;
                    break;
                default:
                    r = 0; g = 0; b = 0;
            }

            return { r: r, g: g, b: b };
        }

        function getAminoAcidOneLetterCode(threeLetterCode) {
            switch (threeLetterCode.toUpperCase()) {
                case 'ALA': 
                    return 'A'; 
                case 'ARG': 
                    return 'R'; 
                case 'ASN': 
                    return 'N'; 
                case 'ASP': 
                    return 'D';
                case 'CYS': 
                    return 'C'; 
                case 'GLN': 
                    return 'Q'; 
                case 'GLU': 
                    return 'E'; 
                case 'GLY': 
                    return 'G';
                case 'HIS': 
                    return 'H'; 
                case 'ILE': 
                    return 'I'; 
                case 'LEU': 
                    return 'L'; 
                case 'LYS': 
                    return 'K';
                case 'MET': 
                    return 'M'; 
                case 'PHE': 
                    return 'F'; 
                case 'PRO': 
                    return 'P'; 
                case 'SER': 
                    return 'S';
                case 'THR': 
                    return 'T'; 
                case 'TRP': 
                    return 'W'; 
                case 'TYR': 
                    return 'Y'; 
                case 'VAL': 
                    return 'V';
                default:
                    return null;
            }
        }

        function downloadSVG(svgSelector, name) {
          var svgClone = $(svgSelector).clone();
          svgClone.find('.svg-pan-zoom_viewport').attr('transform', 'matrix(2.2,0,0,2.2,295,140)');
          
          var escapedSVG = new XMLSerializer().serializeToString(svgClone.get(0));

          downloadURI('data:image/svg+xml;base64,' + window.btoa(escapedSVG), name);
        }

        function downloadSingleCrystalCSV(singleCrystalSvgSelector, name) {
            var data = [];
            var header = ['Residue number 1', 'Residue number 2', 'Segment 1', 'Segment 2',  'Generic number 1', 'Generic number 2', 'Amino acid 1', 'Amino acid 2', 'Interaction type'];
            data.push(header);

            $(singleCrystalSvgSelector + ' rect[data-interaction-type]').each(function(e) {
              var rect = $(this);
              var resNo1 = rect.data('res-no-1');
              var resNo2 = rect.data('res-no-2');
              var seg1 = rect.data('seg-1');
              var seg2 = rect.data('seg-2');
              var genNo1 = rect.data('gen-no-1');
              var genNo2 = rect.data('gen-no-2');
              var aa1 = rect.data('aa-1');
              var aa2 = rect.data('aa-2');
              var iType = rect.data('interaction-type');
              data.push([resNo1, resNo2, seg1, seg2, genNo1, genNo2, aa1, aa2, iType]);
            });

            // Convert to CSV
            var csv = Papa.unparse(data);

            // Download file
            downloadURI('data:text/csv;charset=UTF-8,' + encodeURI(csv), name);
        }

        function populateTableSingleCrystal(singleCrystalSvgSelector) {
          var header = ['Residue number 1', 'Residue number 2', 'Segment 1', 'Segment 2',  'Generic number 1', 'Generic number 2', 'Amino acid 1', 'Amino acid 2', 'Interaction type'];
          var table = [];
          table.push('<table id="single-table" class="table display" width="100%"><thead><tr>');
          header.forEach(function(h) {
            table.push('<th></th>'); //'+h+'
          });
          table.push('</tr</thead>');
          table.push('<tbody>');

          $(singleCrystalSvgSelector + ' rect[data-interaction-type]').each(function(e) {
            var rect = $(this);
            var resNo1 = rect.data('res-no-1');
            var resNo2 = rect.data('res-no-2');
            var seg1 = rect.data('seg-1');
            var seg2 = rect.data('seg-2');
            var genNo1 = rect.data('gen-no-1');
            var genNo2 = rect.data('gen-no-2');
            var aa1 = rect.data('aa-1');
            var aa2 = rect.data('aa-2');
            var iType = rect.data('interaction-type');
            //data.push([resNo1, resNo2, seg1, seg2, genNo1, genNo2, aa1, aa2, iType]);
            table.push('<tr><td>'+resNo1+'</td><td>'+resNo2+'</td><td>'+seg1+'</td><td>'+seg2+'</td><td>'+genNo1+'</td><td>'+genNo2+'</td><td>'+aa1+'</td><td>'+aa2+'</td><td>'+iType+'</td>')
          });
          table.push('</tbody></table>');

          $('#single-table-tab').html(table.join( "" ));

          $("#single-table-tab-link").click(function(e){
              setTimeout(renderSingleTable,100);
          });

        }

        function renderSingleTable() {
          mode = '#single-table-tab';
          if ( ! $.fn.DataTable.isDataTable('#single-table' ) ) {
          oTable[mode] = $('#single-table').DataTable({
                'scrollX': true,
                // 'paging': true,
                // 'autoWidth': true,

                scrollY:        '80vh',
                // scrollCollapse: true,
                paging:         false,
                columnDefs: [
                  { targets: 'no-sort', orderable: false }
                ],
                "aaSorting": [],
              });

              yadcf.init(oTable[mode],
                [
                    {
                        column_number : 0,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Residue #1",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Residue #2",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Segment #1",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Segment #2",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "GN #1",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "GN #2",
                        filter_reset_button_text: false,

                    },
                    {
                        column_number : 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Amino acid #1",
                        filter_reset_button_text: false,

                    }, 
                    {
                        column_number : 7,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Amino acid #2",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 8,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Interaction Type",
                        filter_reset_button_text: false,

                    }, 
                ],
                {
                    cumulative_filtering: false
                }
            );

            yadcf.exResetAllFilters(oTable[mode]);
          }
        }

        function downloadSingleCrystalGroupCSV(singleGroupSvgSelector, name) {
            var data = [];
            var header = ['Generic number 1', 'Generic number 2', 'Segment 1', 'Segment 2', 'Frequency',  'Number of interactions', 'Number of crystals'];
            data.push(header);

            $(singleGroupSvgSelector + ' rect[data-frequency]').each(function(e) {
              var rect = $(this);
              var genNo1 = rect.data('gen-no-1');
              var genNo2 = rect.data('gen-no-2');
              var seg1 = rect.data('seg-1');
              var seg2 = rect.data('seg-2');
              var nInteractions = rect.data('num-interactions');
              var nTotalInteractions = rect.data('total-possible-interactions');
              var frequency = rect.data('frequency');
              data.push([genNo1, genNo2, seg1, seg2, nInteractions, nTotalInteractions, frequency]);
            });

            // Convert to CSV
            var csv = Papa.unparse(data);

            // Download file
            downloadURI('data:text/csv;charset=UTF-8,' + encodeURI(csv), name);
        }

        function downloadTwoCrystalGroupsCSV(twoGroupsSvgSelector, name) {
            var data = [];
            var header = ['Generic number 1', 'Generic number 2', 'Segment 1', 'Segment 2', 'Interactions group 1', 'Interactions group 2', 'Crystals group 1', 'Crystals group 2', 'Frequency group 1', 'Frequency group 2', 'Frequency Difference'];
            data.push(header);

            $(twoGroupsSvgSelector + ' rect[data-frequency-diff]').each(function(e) {
              var rect = $(this);
              var genNo1 = rect.data('gen-no-1');
              var genNo2 = rect.data('gen-no-2');
              var seg1 = rect.data('seg-1');
              var seg2 = rect.data('seg-2');
              var numIntsGroup1 = rect.data('group-1-num-ints');
              var numIntsGroup2 = rect.data('group-2-num-ints');
              var numPdbsGroup1 = rect.data('group-1-num-pdbs');
              var numPdbsGroup2 = rect.data('group-2-num-pdbs');
              var freqGroup1 = rect.data('group-1-freq');
              var freqGroup2 = rect.data('group-2-freq');
              var fDiff = rect.data('frequency-diff').toFixed(2);
              data.push([genNo1, genNo2, seg1, seg2, numIntsGroup1, numIntsGroup2, numPdbsGroup1, numPdbsGroup2, freqGroup1, freqGroup2, fDiff]);
            });

            // Convert to CSV
            var csv = Papa.unparse(data);

            // Download file
            downloadURI('data:text/csv;charset=UTF-8,' + encodeURI(csv), name);
        }

        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }

        function renderSingleCrystalHeatmap(data, heatMapSelector) {

            // Destroy old zoom on heatmap
            if (window.zoomHeatmap[heatMapSelector] != null) {
                window.zoomHeatmap[heatMapSelector].destroy();
                delete window.zoomHeatmap[heatMapSelector];
            }

            // Destroy old legend content
            $(heatMapSelector + ' .heatmap-legend').empty();

            // Destroy all previous contents
            $(heatMapSelector + ' .heatmap').empty();
            var heatmap = Snap(heatMapSelector + ' .heatmap');

            // Draw heatmap
            var interactions = data.interactions;
            var segment_map = data.segment_map;
            var sequence_numbers = data.sequence_numbers;
            var aa_map = data.aa_map[Object.keys(data.aa_map)[0]];
            var gen_map = data.generic_map;
            var num_seq_numbers = Object.keys(data.sequence_numbers).length;

            x = 0; wi = num_seq_numbers;
            y = 0; hi = num_seq_numbers;

            heatmap.attr({viewBox:[x,y,wi,hi].join(',')});
            heatmap.attr({viewBox:[x,y,wi,hi].join(' ')});

            // Contains all labels
            var labelGroup = heatmap.g();

            // Contains all labels
            var contentGroup = heatmap.g();

            // Compute segment offsets
            var i;

            var segments = [];

            var seg, prevSeg = segment_map[sequence_numbers[0]];
            var seqStart = 0;

            for (i = 0; i < num_seq_numbers; i++) {
                seg = segment_map[sequence_numbers[i]];

                if (seg === prevSeg) {
                    continue;
                }

                segments.push({
                    seg: prevSeg,
                    start: seqStart,
                    end: i-1
                });

                seqStart = i;
                prevSeg = seg;
            }

            // Push last segment
            segments.push({
                seg: prevSeg,
                start: seqStart,
                end: i-1
            });

            // Draw segments
            segments.forEach(function(s) {
                var rgb = getSegmentColor(s.seg);

                // Place the segments vertically.
                var cell = heatmap.rect(s.start, 0, s.end - s.start + 1, num_seq_numbers);
                var line = heatmap.line(s.start, 0, s.start, num_seq_numbers);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });

                // Add text
                var label = heatmap.text(s.start + (s.end - s.start + 1)/2 - 6, 9 + cell.getBBox().height, s.seg);

                label.attr({
                    'text-anchor': 'start',
                    'font-size': 5
                });

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);

                label.transform("r270s-1,1");
            });

            segments.forEach(function(s) {
                rgb = getSegmentColor(s.seg);

                // Place the segments horizontally.
                cell = heatmap.rect(0, s.start, num_seq_numbers, s.end - s.start + 1);
                line = heatmap.line(0, s.end+1, num_seq_numbers, s.end+1);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });

                var label = heatmap.text(-2, s.start + (s.end - s.start + 1)/2, s.seg);

                label.attr({
                    'text-anchor': 'end',
                    'font-size': 5,
                    'alignment-baseline': 'middle'
                });

                label.transform("r180s-1,1");

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);
            });


            // Draw cells
            for (i = 0; i < num_seq_numbers; i++) {
                for (var j = 0; j < num_seq_numbers; j++) {
                    // Get the sequence numbers
                    var seq_i = data.sequence_numbers[i];
                    var seq_j = data.sequence_numbers[j];

                    // Only draw if an interaction exists
                    var num = seq_i + "," + seq_j;

                    if (num in interactions) {
                        var cells = [];
                        // Get all interactions at a given coordinate
                        getInteractionTypesFromPdbObject(interactions[num]).forEach(function(interaction) {
                            var rgb = getInteractionColor(interaction);
                            var cell = heatmap.rect(i, j, 1, 1);

                            var interactionsString = getInteractionTypesFromPdbObject(interactions[num]).map(getFriendlyInteractionName).filter(function(item, pos, self) {
                                return self.indexOf(item) == pos;
                            }).join(", ");

                            var content, title = 'Residues ' + aa_map[seq_i] + seq_i + '-' + aa_map[seq_j] + seq_j + '<br />'
                                    + 'Interactions: ' + interactionsString + '<br />'
                                    + 'Segments: ' + segment_map[seq_i] + ', ' + segment_map[seq_j] + '<br />';

                            // Add generic numbers where applicable
                            if (seq_i in gen_map) {
                                title += 'Res. 1 gen. no: ' + gen_map[seq_i] + '<br />';
                            }

                            if (seq_j in gen_map) {
                                title += 'Res. 2 gen. no: ' + gen_map[seq_j] + '<br />';
                            }

                            var genStrI = gen_map[seq_i];
                            var genStrJ = gen_map[seq_j];

                            if (typeof gen_map[seq_i] == 'undefined') {
                                genStrI = '-';
                            }

                            if (typeof gen_map[seq_j] == 'undefined') {
                                genStrJ = '-';
                            }

                            var popoverTable = '<table class="table">'
                            + '<thead>'
                            + '<tr>'
                            + '<th>Residue</th>'
                            + '<th>' + aa_map[seq_i] + seq_i + '</th>'
                            + '<th>' + aa_map[seq_j] + seq_j + '</th>'
                            + '</tr>'
                            + '</thead>'
                            + '<tbody>'
                            + '<td>Segment</td>'
                            + '<td>' + segment_map[seq_i] + '</td>'
                            + '<td>' + segment_map[seq_j] + '</td>'
                            + '</tr>'
                            + '<tr>'
                            + '<td>Gen. no.</td>'
                            + '<td>' + genStrI + '</td>'
                            + '<td>' + genStrJ + '</td>'
                            + '</tr>'
                            + '</tbody>'
                            + '</table>'
                            + '<table class="table">'
                            + '<thead>'
                            + '<tr>'
                            + '<th>Interactions</th>'
                            + '</tr>'
                            + '<tr>'
                            + '</thead>'
                            + '<tbody>'
                            + '<tr>'
                            + '<td>' + interactionsString + '</td>'
                            + '</tr>'
                            + '</tbody>'
                            + '</table>'

                            var interactionId = 'single-i-' + num.replace(',','-');

                            // Create cell for interaction
                            cell.attr({
                                'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                                'data-interaction-type': interaction,
                                'data-res-no-1': seq_i,
                                'data-res-no-2': seq_j,
                                'data-aa-1': aa_map[seq_i],
                                'data-aa-2': aa_map[seq_j],
                                'data-seg-1': segment_map[seq_i],
                                'data-seg-2': segment_map[seq_j],
                                'data-gen-no-1': genStrI,
                                'data-gen-no-2': genStrJ,
                                'class': 'heatmap-interaction' + ' ' + getFriendlyInteractionName(interaction).replace(/ /g,"-"),
                                'id': interactionId
                            });

                            contentGroup.add(cell);

                            // Add tooltip to cell
                            cell = $(heatMapSelector + ' rect.heatmap-interaction#' + interactionId);

                            cell.tooltip({
                                'container': heatMapSelector,
                                'placement': 'top',
                                'delay': 75,
                                'html': true,
                                'title': title
                            });

                            // Add popover to cells
                            cell.popover({
                                'container': heatMapSelector,
                                'placement': 'bottom',
                                'animation': true,
                                'html': true,
                                'title': 'Interactions at ' + aa_map[seq_i] + seq_i + ', ' + aa_map[seq_j] + seq_j,
                                'content': popoverTable,
                                'tabindex': '0'
                            });

                            cells.push(cell);
                        });
                    }
                }
            }

            // Add cover-up triangle
            var bbox = contentGroup.getBBox();
            contentGroup.add(heatmap.polygon([bbox.x, bbox.y, bbox.x2, bbox.y, bbox.x2, bbox.y2]).attr({ fill: "white" }));

            // Add bottom line
            var line = heatmap.line(bbox.x, bbox.y, bbox.x2, bbox.y2);
            line.attr({
                'stroke': "rgb(150,150,150)",
                'strokeWidth': "0.1"
            });
            contentGroup.add(line);

            // Rotate contents
            var g = heatmap.g();
            g.add(contentGroup);
            g.add(labelGroup);
            g.transform("r225s-1,1");


            // Populate heatmap legend
            var interactionTypes = new Set();

            $(heatMapSelector + ' .heatmap-interaction').each(function() {
                var friendlyName = getFriendlyInteractionName($(this).data('interaction-type'));
                interactionTypes.add(friendlyName);
            });

            // Add interactions color legend
            var legendHtml = '<ul>';

            interactionTypes = Array.from(interactionTypes).sort(function (i1, i2) {
                return getInteractionStrength(i2) - getInteractionStrength(i1);
            });

            interactionTypes.forEach(function(i) {
                var rgb = getInteractionColor(i);
                legendHtml = legendHtml
                        + '<li>'
                        + '<div class="color-box" style="background-color: ' + rgb2hex(rgb.r, rgb.g, rgb.b) + '">' + '<input type="checkbox" data-interaction-type="' + i.replace(/ /g,"-") +'"></input>' + '</div><p>' + i + '</p>'
                        + '</li>';
            });
            legendHtml += '</ul>';

            // Add SVG download button
            legendHtml += '<button onclick="downloadSVG(\'' + heatMapSelector + ' .heatmap\', \'interactions.svg\')" type="button" class="btn btn-primary pull-right svg-download-button" aria-label="Left Align">' +
                            '<span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download SVG' +
                          '</button>';

            // Add CSV download button
            legendHtml += '<br /><button onclick="downloadSingleCrystalCSV(\'' + heatMapSelector + ' .heatmap\', \'interactions.csv\')" type="button" class="btn btn-success pull-right csv-download-button" aria-label="Left Align"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download CSV' +
              '</button>';

            $(heatMapSelector + ' .heatmap-legend').append(legendHtml);

            $(heatMapSelector + ' .heatmap-legend input[type=checkbox]').each(function() {
                $(this).prop('checked', true);
                $(this).change(function() {
                    var interactionType = $(this).data('interaction-type');
                    var rects = $(heatMapSelector + ' .heatmap rect.' + interactionType);
                    if ($(this).is(':checked')) {
                        rects.show();
                    } else {
                        rects.hide();
                    }
                });
            });


            // Make zoomable
            window.zoomHeatmap[heatMapSelector] = svgPanZoom(heatMapSelector + ' .heatmap', {
                zoomEnabled: true,
                // controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.75,
                maxZoom: 50,
                zoomScaleSensitivity: 0.25,
                dblClickZoomEnabled: true,
                beforeZoom: hidePopovers,
                beforePan: hidePopovers
            });

            // Set initial zoom level
            window.zoomHeatmap[heatMapSelector].zoom(1);
            window.zoomHeatmap[heatMapSelector].pan({x: 325, y: 140});

            // Close popovers on clicking elsewhere
            $('html').on('mousedown', function(e) {
                if(!$(e.target).closest('.popover').length) {
                    if ($(e.target).closest(heatMapSelector).length) {
                        hidePopovers();
                    }
                }
            });

            // Create table view
            populateTableSingleCrystal(heatMapSelector);
        }

        function renderSingleCrystalGroupHeatmap(data, heatMapSelector) {

            // Destroy old zoom on heatmap
            if (window.zoomHeatmap[heatMapSelector] != null) {
                window.zoomHeatmap[heatMapSelector].destroy();
                delete window.zoomHeatmap[heatMapSelector];
            }

            // Destroy old legend content
            $(heatMapSelector + ' .heatmap-legend').empty();

            // Destroy all previous contents
            $(heatMapSelector + ' .heatmap').empty();
            var heatmap = Snap(heatMapSelector + ' .heatmap');

            // Draw heatmap
            var interactions = data.interactions;
            var segment_map = data.segment_map;
            var sequence_numbers = data.sequence_numbers;
            var num_seq_numbers = Object.keys(data.sequence_numbers).length;

            x = 0; wi = num_seq_numbers;
            y = 0; hi = num_seq_numbers;

            heatmap.attr({viewBox:[x,y,wi,hi].join(',')});
            heatmap.attr({viewBox:[x,y,wi,hi].join(' ')});

            // Contains all labels
            var labelGroup = heatmap.g();

            // Contains all content
            var contentGroup = heatmap.g();

            // Compute segment offsets
            var i;

            var segments = [];

            var seg, prevSeg = segment_map[sequence_numbers[0]];
            var seqStart = 0;

            for (i = 0; i < num_seq_numbers; i++) {
                seg = segment_map[sequence_numbers[i]];

                if (seg === prevSeg) {
                    continue;
                }

                segments.push({
                    seg: prevSeg,
                    start: seqStart,
                    end: i-1
                });

                seqStart = i;
                prevSeg = seg;
            }

            // Push last segment
            segments.push({
                seg: prevSeg,
                start: seqStart,
                end: i-1
            });

            // Draw segments
            segments.forEach(function(s) {
                var rgb = getSegmentColor(s.seg);

                // Place the segments vertically.
                var cell = heatmap.rect(s.start, 0, s.end - s.start + 1, num_seq_numbers);
                var line = heatmap.line(s.start, 0, s.start, num_seq_numbers);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });


                // Add text
                var label = heatmap.text(s.start + (s.end - s.start + 1)/2 - 6, 9 + cell.getBBox().height, s.seg);

                label.attr({
                    'text-anchor': 'start',
                    'font-size': 5
                });

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);

                label.transform("r270s-1,1");
            });

            segments.forEach(function(s) {
                rgb = getSegmentColor(s.seg);

                // Place the segments horizontally.
                cell = heatmap.rect(0, s.start, num_seq_numbers, s.end - s.start + 1);
                line = heatmap.line(0, s.end+1, num_seq_numbers, s.end+1);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });

                var label = heatmap.text(-2, s.start + (s.end - s.start + 1)/2, s.seg);

                label.attr({
                    'text-anchor': 'end',
                    'font-size': 5,
                    'alignment-baseline': 'middle'
                });

                label.transform("r180s-1,1");

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);
            });

            // Draw cells
            for (i = 0; i < num_seq_numbers; i++) {
                for (var j = 0; j < num_seq_numbers; j++) {
                    // Get the sequence numbers
                    var seq_i = data.sequence_numbers[i];
                    var seq_j = data.sequence_numbers[j];

                    // Only draw if an interaction exists
                    var num = seq_i + "," + seq_j;

                    if (num in interactions) {
                        // Get the strongest interaction.
                        var nInteractions = Object.keys(interactions[num]).length;
                        var frequency = nInteractions / data.pdbs.length;

                        var rgb = { r: 255, g: 255-frequency*255, b: 255-frequency*255 };
                        var cell = heatmap.rect(i, j, 1, 1);

                        var title =  'Residues ' + seq_i + ', ' + seq_j + '<br />'
                                + 'Interaction count: ' + nInteractions + '<br />'
                                + segment_map[seq_i] + ', ' + segment_map[seq_j];

                        var popoverTable = '<table class="table">'
                            + '<thead>'
                            + '<tr>'
                            + '<th>Residue #</th>'
                            + '<th>' + seq_i + '</th>'
                            + '<th>' + seq_j + '</th>'
                            + '</tr>'
                            + '</thead>'
                            + '<tbody>'
                            + '<td>Segment</td>'
                            + '<td>' + segment_map[seq_i] + '</td>'
                            + '<td>' + segment_map[seq_j] + '</td>'
                            + '</tr>'
                            + '</tbody>'
                            + '</table>'
                            + 'Interaction count: ' + nInteractions + '<br />'
                            + 'Interaction frequency: ' + frequency.toFixed(2)

                        cell.attr({
                            'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                            'data-num-interactions': nInteractions,
                            'data-total-possible-interactions': data.pdbs.length,
                            'data-frequency': frequency,
                            'data-gen-no-1': seq_i,
                            'data-gen-no-2': seq_j,
                            'data-seg-1': segment_map[seq_i],
                            'data-seg-2': segment_map[seq_j],
                            'class': 'heatmap-interaction'
                        });

                        $(heatMapSelector + ' rect.heatmap-interaction').tooltip({
                            'container': heatMapSelector,
                            'placement': 'top',
                            'delay': 75,
                            'title': title,
                            'html': true
                        });

                        // Add popover to cells
                        $(heatMapSelector + ' rect.heatmap-interaction').popover({
                            'container': heatMapSelector,
                            'placement': 'bottom',
                            'animation': true,
                            'html': true,
                            'title': 'Interactions at ' + seq_i + ', ' + seq_j,
                            'content': popoverTable,
                            'tabindex': '0'
                        });

                        contentGroup.add(cell);
                    }
                }
            }

            // Add cover-up triangle
            var bbox = contentGroup.getBBox();
            contentGroup.add(heatmap.polygon([bbox.x, bbox.y, bbox.x2, bbox.y, bbox.x2, bbox.y2]).attr({ fill: "white" }));

            // Rotate contents
            var g = heatmap.g();
            g.add(contentGroup);
            g.add(labelGroup);
            g.transform("r225s-1,1");

            // Populate heatmap legend
            var legendHtml = '<h4 class="center">Interaction count</h4>'
                + '<p>Range: <span id="pdbs-range">0 - ' + data.pdbs.length + '</span></p>'
                + '<div class="slider-range" data-text-id="pdbs-range" id="pdbs-range-slider"></div>'
                + '<div class="temperature-scale">'
                + '<span class="white-to-red"></span>'
                + '</div>';

            // Add SVG download button
            legendHtml += '<button onclick="downloadSVG(\'' + heatMapSelector + ' .heatmap\', \'interactions.svg\')" type="button" class="btn btn-primary pull-right svg-download-button" aria-label="Left Align">' +
                            '<span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download SVG' +
                          '</button>';

            // Add CSV download button
            legendHtml += '<br /><button onclick="downloadSingleCrystalGroupCSV(\'' + heatMapSelector + ' .heatmap\', \'interactions.csv\')" type="button" class="btn btn-success pull-right csv-download-button" aria-label="Left Align"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download CSV' +
              '</button>';


            $(heatMapSelector + ' .heatmap-legend').append(legendHtml); 

            $( function() {
              $( ".slider-range" ).slider({
                range: true,
                min: 0,
                max: data.pdbs.length,
                step: 1,
                values: [0,data.pdbs.length],
                slide: function( event, ui ) {
                  $( "#"+$(this).attr("data-text-id") ).html( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                  setTimeout(getRangeChangeFunction,100)
                }
              });
            } );

            function getRangeChangeFunction() {

                    var [tMin,tMax] = $(heatMapSelector + ' .heatmap-legend #pdbs-range-slider').slider( "option", "values" );

                    // Hide all below min treshold
                    $(heatMapSelector + ' rect').each(function() {
                        var n = $(this).data("num-interactions");
                        if (n < tMin || tMax < n) {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
                
            }

            // Make zoomable
            window.zoomHeatmap[heatMapSelector] = svgPanZoom(heatMapSelector + ' .heatmap', {
                zoomEnabled: true,
                // controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.75,
                maxZoom: 50,
                zoomScaleSensitivity: 0.25,
                dblClickZoomEnabled: true,
                beforeZoom: hidePopovers,
                beforePan: hidePopovers
            });

            // Set initial zoom level
            window.zoomHeatmap[heatMapSelector].zoom(1);
            window.zoomHeatmap[heatMapSelector].pan({x: 325, y: 140});

            // Close popovers on clicking elsewhere
            $('html').on('mousedown', function(e) {
                if(!$(e.target).closest('.popover').length) {
                    if ($(e.target).closest(heatMapSelector).length) {
                        hidePopovers();
                    }
                }
            });
        }

        function renderTwoCrystalGroupsHeatmap(data1, data2, data3, heatMapSelector) {

            // Destroy old zoom on heatmap
            if (window.zoomHeatmap[heatMapSelector] != null) {
                window.zoomHeatmap[heatMapSelector].destroy();
                delete window.zoomHeatmap[heatMapSelector];
            }

            // Destroy old legend content
            $(heatMapSelector + ' .heatmap-legend').empty();

            // Destroy all previous contents
            $(heatMapSelector + ' .heatmap').empty();
            var heatmap = Snap(heatMapSelector + ' .heatmap');

            // Draw heatmap
            var interactions = data3.interactions;
            var segment_map = data3.segment_map;
            var sequence_numbers = data3.sequence_numbers;
            var num_seq_numbers = Object.keys(data3.sequence_numbers).length;

            x = 0; wi = num_seq_numbers;
            y = 0; hi = num_seq_numbers;

            heatmap.attr({viewBox:[x,y,wi,hi].join(',')});
            heatmap.attr({viewBox:[x,y,wi,hi].join(' ')});

            // Contains all labels
            var labelGroup = heatmap.g();

            // Contains all labels
            var contentGroup = heatmap.g();

            // Compute segment offsets
            var i;

            var segments = [];

            var seg, prevSeg = segment_map[sequence_numbers[0]];
            var seqStart = 0;

            for (i = 0; i < num_seq_numbers; i++) {
                seg = segment_map[sequence_numbers[i]];

                if (seg === prevSeg) {
                    continue;
                }

                segments.push({
                    seg: prevSeg,
                    start: seqStart,
                    end: i-1
                });

                seqStart = i;
                prevSeg = seg;
            }

            // Push last segment
            segments.push({
                seg: prevSeg,
                start: seqStart,
                end: i-1
            });

            // Draw segments
            segments.forEach(function(s) {
                var rgb = getSegmentColor(s.seg);

                // Place the segments vertically.
                var cell = heatmap.rect(s.start, 0, s.end - s.start + 1, num_seq_numbers);
                var line = heatmap.line(s.start, 0, s.start, num_seq_numbers);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });

                // Add text
                var label = heatmap.text(s.start + (s.end - s.start + 1)/2 - 6, 9 + cell.getBBox().height, s.seg);

                label.attr({
                    'text-anchor': 'start',
                    'font-size': 5
                });

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);

                label.transform("r270s-1,1");
            });

            segments.forEach(function(s) {
                rgb = getSegmentColor(s.seg);

                // Place the segments horizontally.
                cell = heatmap.rect(0, s.start, num_seq_numbers, s.end - s.start + 1);
                line = heatmap.line(0, s.end+1, num_seq_numbers, s.end+1);

                cell.attr({
                    'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                    'fill-opacity': "0.5"
                });

                line.attr({
                    'stroke': "rgb(150,150,150)",
                    'strokeWidth': "0.1"
                });

                var label = heatmap.text(-2, s.start + (s.end - s.start + 1)/2, s.seg);

                label.attr({
                    'text-anchor': 'end',
                    'font-size': 5,
                    'alignment-baseline': 'middle'
                });

                label.transform("r180s-1,1");

                contentGroup.add(cell);
                contentGroup.add(line);
                labelGroup.add(label);
            });

            // Draw cells
            for (i = 0; i < num_seq_numbers; i++) {
                for (var j = 0; j < num_seq_numbers; j++) {
                    // Get the sequence numbers
                    var seq_i = data3.sequence_numbers[i];
                    var seq_j = data3.sequence_numbers[j];

                    // Only draw if an interaction exists
                    var num = seq_i + "," + seq_j;

                    var n1 = 0;
                    var n2 = 0;

                    if (num in data1.interactions) {
                        n1 = Object.keys(data1.interactions[num]).length;
                    }

                    if (num in data2.interactions) {
                        n2 = Object.keys(data2.interactions[num]).length;
                    }

                    if ((num in data1.interactions) || (num in data2.interactions)) {
                        // Difference in frequencies
                        var f1 = (n1 / data1.pdbs.length);
                        var f2 = (n2 / data2.pdbs.length);
                        var fDiff = (n1 / data1.pdbs.length) - (n2 / data2.pdbs.length);

                        if (fDiff <= 0) {
                            // If fDiff is close to -1, we want a red color
                            var rgb = { r: 255, g: 255-255*(-fDiff), b: 255-255*(-fDiff) };
                        } else {
                            // If fDiff is close to 1 we want a blue color
                            var rgb = { r: 255-255*fDiff, g: 255-255*fDiff, b: 255 };
                        }

                        var cell = heatmap.rect(i, j, 1, 1);

                        var title =  'Residues ' + seq_i + ', ' + seq_j + '<br />' 
                                   + 'Frequency group 1: ' + f1.toFixed(2)+ '<br />' 
                                   + 'Frequency group 2: ' + f2.toFixed(2)+ '<br />' 
                                   + 'Frequency difference: ' + fDiff.toFixed(2)+ '<br />' ;

                        var popoverTable = '<table class="table">'
                            + '<thead>'
                            + '<tr>'
                            + '<th>Residue #</th>'
                            + '<th>' + seq_i + '</th>'
                            + '<th>' + seq_j + '</th>'
                            + '</tr>'
                            + '</thead>'
                            + '<tbody>'
                            + '<td>Segment</td>'
                            + '<td>' + segment_map[seq_i] + '</td>'
                            + '<td>' + segment_map[seq_j] + '</td>'
                            + '</tr>'
                            + '</tbody>'
                            + '</table>'
                            + 'Group 1 freq: ' + f1.toFixed(2) + '<br />'
                            + 'Group 2 freq: ' + f2.toFixed(2) + '<br />'
                            + 'Frequency difference: ' + fDiff.toFixed(2)

                        cell.attr({
                            'fill': "rgb(" + [rgb.r, rgb.g, rgb.b].join(',') + ")",
                            'data-frequency-diff': fDiff,
                            'data-gen-no-1': seq_i,
                            'data-gen-no-2': seq_j,
                            'data-seg-1': segment_map[seq_i],
                            'data-seg-2': segment_map[seq_j],
                            'data-group-1-num-ints': n1,
                            'data-group-2-num-ints': n2,
                            'data-group-1-num-pdbs': data1.pdbs.length,
                            'data-group-2-num-pdbs': data2.pdbs.length,
                            'data-group-1-freq': f1.toFixed(2),
                            'data-group-2-freq': f2.toFixed(2),
                            'class': 'heatmap-interaction'
                        });

                        $(heatMapSelector + ' rect.heatmap-interaction').tooltip({
                            'container': heatMapSelector,
                            'placement': 'top',
                            'delay': 75,
                            'html': true,
                            'title': title
                        });

                        // Add popover to cells
                        $(heatMapSelector + ' rect.heatmap-interaction').popover({
                            'container': heatMapSelector,
                            'placement': 'bottom',
                            'animation': true,
                            'html': true,
                            'title': 'Interactions at ' + seq_i + ', ' + seq_j,
                            'content': popoverTable,
                            'tabindex': '0'
                        });

                        contentGroup.add(cell);
                    }
                }
            }

            // Add cover-up triangle
            var bbox = contentGroup.getBBox();
            contentGroup.add(heatmap.polygon([bbox.x, bbox.y, bbox.x2, bbox.y, bbox.x2, bbox.y2]).attr({ fill: "white" }));

            // Rotate contents
            var g = heatmap.g();
            g.add(contentGroup);
            g.add(labelGroup);
            g.transform("r225s-1,1");

            // Populate heatmap legend
            var legendHtml = '<h4 class="center">Frequency</h4>'
                + '<p>Group 1 range: <span id="freq-range-1">0 - 1</span></p>'
                + '<div class="slider-range" data-text-id="freq-range-1" id="freq-slider-range-1"></div>'
                + '<p>Group 2 range: <span id="freq-range-2">0 - 1</span></p>'
                + '<div class="slider-range" data-text-id="freq-range-2" id="freq-slider-range-2"></div>'
                + '<p>Freq difference range: <span id="freq-range-3">-1 - 1</span></p>'
                + '<div class="slider-range-diff" data-text-id="freq-range-3" id="freq-slider-range-3"></div>'
                + '<div class="temperature-scale">'
                + '<span class="red-to-white"></span>'
                + '<span class="white-to-blue"></span>'
                + '</div>'
                + '</div>';

            // Add SVG download button
            legendHtml += '<button onclick="downloadSVG(\'' + heatMapSelector + ' .heatmap\', \'interactions.svg\')" type="button" class="btn btn-primary pull-right svg-download-button" aria-label="Left Align">' +
                            '<span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download SVG' +
                          '</button>';

            // Add CSV download button
            legendHtml += '<br /><button onclick="downloadTwoCrystalGroupsCSV(\'' + heatMapSelector + ' .heatmap\', \'interactions.csv\')" type="button" class="btn btn-success pull-right csv-download-button" aria-label="Left Align"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download CSV' +
              '</button>';

            $(heatMapSelector + ' .heatmap-legend').append(legendHtml); 

            $( function() {
              $( ".slider-range" ).slider({
                range: true,
                min: 0,
                max: 1,
                step: 0.01,
                values: [0,1],
                slide: function( event, ui ) {
                  $( "#"+$(this).attr("data-text-id") ).html( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                  setTimeout(getRangeChangeFunction,100)
                }
              });
            } );
            $( function() {
              $( ".slider-range-diff" ).slider({
                range: true,
                min: -1,
                max: 1,
                step: 0.01,
                values: [-1,1],
                slide: function( event, ui ) {
                  $( "#"+$(this).attr("data-text-id") ).html( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                  setTimeout(getRangeChangeFunction,100)
                }
              });
            } );


            function getRangeChangeFunction() {

                    var r1 = $(heatMapSelector + ' .heatmap-legend #freq-slider-range-1').slider( "option", "values" );
                    var r2 = $(heatMapSelector + ' .heatmap-legend #freq-slider-range-2').slider( "option", "values" );
                    var r3 = $(heatMapSelector + ' .heatmap-legend #freq-slider-range-3').slider( "option", "values" );

                    // Hide all below min treshold
                    $(heatMapSelector + ' rect').each(function() {
                        var f1 = $(this).data("group-1-freq");
                        var f2 = $(this).data("group-2-freq");
                        var f3 = $(this).data("frequency-diff");
                        if ( (f1 < r1[0] || r1[1] < f1) || (f2 < r2[0] || r2[1] < f2) || (f3 < r3[0] || r3[1] < f3) ) {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
            }

            // Make zoomable
            window.zoomHeatmap[heatMapSelector] = svgPanZoom(heatMapSelector + ' .heatmap', {
                zoomEnabled: true,
                // controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.75,
                maxZoom: 50,
                zoomScaleSensitivity: 0.25,
                dblClickZoomEnabled: true,
                beforeZoom: hidePopovers,
                beforePan: hidePopovers
            });

            // Set initial zoom level
            window.zoomHeatmap[heatMapSelector].zoom(1);
            window.zoomHeatmap[heatMapSelector].pan({x: 325, y: 140});

            // Close popovers on clicking elsewhere
            $('html').on('mousedown', function(e) {
                if(!$(e.target).closest('.popover').length) {
                    if ($(e.target).closest(heatMapSelector).length) {
                        hidePopovers();
                    }
                }
            });
        }

        function initializeSegmentButtons(selector) {
            // Initialize segment buttons.
            $(selector + ' .segments-panel button').each(function() {
                var s = $(this).attr('data-segment');

                // Return if no segment data
                if (s == null) {
                    return;
                }

                $(this).click(function() {
                    var segments = [];
                    $(this).toggleClass('active');
                    $(selector + ' .segments-panel button.active').each(function() {
                        segments = segments.concat($(this).data('segment').split(' '));
                    });
                    $(selector + ' .segments-input').val(JSON.stringify(segments));
                });
            });

            // Initialize 'all' buttons.
            $(selector  + ' .segments-panel .all-button').each(function() {
                $(this).click(function() {
                    if ($(this).html() === 'All') {
                        $(this).html('None');
                        $(this).parent().find('button').each(function() {
                            var s = $(this).attr('data-segment');

                            // Return if no segment data
                            if (s == null) {
                                return;
                            }

                            if (!$(this).hasClass('active')) {
                                $(this).trigger('click');
                            }
                        });
                    } else {
                        $(this).html('All');
                        $(this).parent().find('button').each(function() {
                            var s = $(this).attr('data-segment');

                            // Return if no segment data
                            if (s == null) {
                                return;
                            }

                            if ($(this).hasClass('active')) {
                                $(this).trigger('click');
                            }
                        });
                    }

                }); 

                // Update data
                var segments = [];
                $(selector + ' .segments-panel button.active').each(function() {
                    segments.push($(this).data('segment'));
                });
                $(selector + ' .segments-panel .segments-input').val(JSON.stringify(segments));

                // Trigger click on initialization
                $(this).trigger('click');
            });
        }

        function initializeInteractionButtons(selector) {
            // Initialize interaction buttons.
            $(selector + ' .interactions-panel button').each(function() {
                var s = $(this).attr('data-interaction-type');

                // Return if no segment data
                if (s == null) {
                    return;
                }

                $(this).click(function() {
                    var interactions = [];
                    $(this).toggleClass('active');
                    $(selector + ' .interactions-panel button.active').each(function() {
                        interactions = interactions.concat($(this).data('interaction-type').split(' '));
                    });
                    $(selector + ' .interactions-input').val(JSON.stringify(interactions));
                });
            });

            // Initialize 'all' buttons.
            $(selector  + ' .interactions-panel .all-button').each(function() {
                $(this).click(function() {
                    if ($(this).html() === 'All') {
                        $(this).html('None');
                        $(this).parent().find('button').each(function() {
                            var s = $(this).attr('data-interaction-type');

                            // Return if no segment data
                            if (s == null) {
                                return;
                            }

                            if (!$(this).hasClass('active')) {
                                $(this).trigger('click');
                            }
                        });
                    } else {
                        $(this).html('All');
                        $(this).parent().find('button').each(function() {
                            var s = $(this).attr('data-interaction-type');

                            // Return if no segment data
                            if (s == null) {
                                return;
                            }

                            if ($(this).hasClass('active')) {
                                $(this).trigger('click');
                            }
                        });
                    }
                }); 

                // Update data
                var interactions = [];
                $(selector + ' .interactions-panel button.active').each(function() {
                    interactions.push($(this).data('interaction-type'));
                });
                $(selector + ' .interactions-input').val(JSON.stringify(interactions));

                // Trigger click on initialization
                $(this).trigger('click');
            });
        }

        function initializeGoButton(selector, heatmapFunction, generic=false) {
            $(selector + ' .go-button').click(function() {
                var pdb = JSON.parse($(selector + ' .crystal-pdb').val());
                var segments = JSON.parse($(selector + ' .segments-input').val());
                var interactionTypes = JSON.parse($(selector + ' .interactions-input').val());
                $(".heatmap").hide();
                $(".heatmap-legend").hide();
                
                $(selector + ' .heatmap-container').append('<span id=svgloading>Loading...</span>');
                if (!$(selector + ' .interactions-input').val() == null) 
                    interactionTypes = JSON.parse($(selector + ' .interactions-input').val());

                $.getJSON( '/contactnetwork/interactiondata',
                {
                    'segments': segments,
                    'generic': generic,
                    'pdbs': pdb,
                    'interaction_types': interactionTypes
                },
                function( data ) {
                    // Re-render heatmap
                    $(".heatmap").show();
                    $(".heatmap-legend").show();
                    heatmapFunction(data, selector + ' .heatmap-container');
                    $("#svgloading").remove()
                    // Re-render flareplot
                    createFlareplot(600, parseGPCRdb2flare(data), selector + " .flareplot-container"); //flareplot-container
                    createSchematicPlot(data, ".schematic-con-container"); //.schematic-container

                    createSchematicPlot(data, ".schematic-non-container", {isContiguousPlot: false})

                    createNGLview("single",pdb);
                });
            });
        }

        function initializeGoButtonTwoCrystalGroups(selector, heatmapFunction, generic=false) {
            $(selector + ' .go-button').click(function() {
                var pdbs1 = JSON.parse($(selector + ' .crystal-group-1-pdbs').val());
                var pdbs2 = JSON.parse($(selector + ' .crystal-group-2-pdbs').val());
                var segments = JSON.parse($(selector + ' .segments-input').val());
                var interactionTypes = JSON.parse($(selector + ' .interactions-input').val());
                $(".heatmap").hide();
                $(".heatmap-legend").hide();
                $(selector + ' .heatmap-container').append('<span id=svgloading>Loading... (0%)</span>');

                $.getJSON( '/contactnetwork/interactiondata',
                {
                    'segments': segments,
                    'generic': generic,
                    'pdbs': pdbs1,
                    'interaction_types': interactionTypes
                },
                function( data1 ) {
 
                    $("#svgloading").remove();
                    $(selector + ' .heatmap-container').append('<span id=svgloading>Loading... (33%)</span>');
                    $.getJSON( '/contactnetwork/interactiondata',
                    {
                        'segments': segments,
                        'generic': generic,
                        'pdbs': pdbs2,
                        'interaction_types': interactionTypes
                    },
                    function( data2 ) {
                        $("#svgloading").remove();
                        $(selector + ' .heatmap-container').append('<span id=svgloading>Loading... (66%)</span>');
                        $.getJSON( '/contactnetwork/interactiondata',
                        {
                            'segments': segments,
                            'generic': generic,
                            'pdbs': pdbs1.concat(pdbs2),
                            'interaction_types': interactionTypes
                        }, function ( data3 ) {
                        // Re-render heatmap
                        $(".heatmap").show();
                        $(".heatmap-legend").show();
                        $("#svgloading").remove()
                        heatmapFunction(data1, data2, data3, selector + ' .heatmap-container');
                        });
                    });
                });
            });
        }

        function initializeFullscreenButton(selector) {
            var fullScreenElement = $(selector + ' .heatmap-container').get(0);
            $(selector + ' .btn-fullscreen').click(function() {
                toggleFullScreen(fullScreenElement);
            });
        }


        function update_text_in_modal() {
          var mode = $('ul#mode_nav').find('li.active').find('a').text().trim();

          if (mode=='Single group of structures') {
            var total_selected = $('.pdb_selected:checked', oTable[mode].cells().nodes()).length
            var selected_visible = $('.pdb_selected:checked').length 
            var ModalpdbsCountSelector = '#single-crystal-group-pdbs-modal-text';

            if (total_selected==selected_visible) {
              $(ModalpdbsCountSelector).html(total_selected +' structure(s) selected');
            } else {
              $(ModalpdbsCountSelector).html(total_selected +' structure(s) selected ('+(total_selected-selected_visible)+' currently filtered)');
            }
          } else if (mode=='Two groups of structures') {
            group = $('.tableview:visible').attr('group-number');
            if (group) mode = mode + group;
            //#FIXME 
            var ModalpdbsCountSelector = '#two-crystal-group-pdbs-modal-'+group+'-text';
            var total_selected = $('.pdb_selected:checked', oTable[mode].cells().nodes()).length
            var selected_visible = $('.pdb_selected:checked:visible').length 
            if (total_selected==selected_visible) {
              $(ModalpdbsCountSelector).html(total_selected +' structure(s) selected');
            } else {
              $(ModalpdbsCountSelector).html(total_selected +' structure(s) selected ('+(total_selected-selected_visible)+' currently filtered)');
            }
          }


        }

        function thisPDB(elem) {
          var mode = $('ul#mode_nav').find('li.active').find('a').text().trim();
          var ReceptorName = $(elem).attr('long');
          var pdbName = $(elem).attr('id');
          if (mode=='Single structure') {
            $('.pdb_selected').not(elem).prop("checked",false);
            var pdbs = [];
            if ($(elem).prop("checked")) {
              pdbs.push(pdbName);
              // Update view
              $(".crystal-count:visible").html(ReceptorName + ' - ' + pdbName + ' selected.');
            } else {
              // Update view
              $(".crystal-count:visible").html('No structure selected.');
            }
            $(".crystal-count:visible").parent().parent().find('.crystal-pdb').val(JSON.stringify(pdbs));
          } else if (mode=='Single group of structures') {
            var pdbs = [];
            $('.pdb_selected:checked', oTable[mode].cells().nodes()).each(function() {
                pdbs.push($(this).attr('id'));
            });
            var pdbsInputSelector = '#single-crystal-group-tab .crystal-pdb';
            var pdbsCountSelector = '#single-crystal-group-tab .crystal-count';
            var ModalpdbsCountSelector = '#single-crystal-group-pdbs-modal-text';

            $(pdbsInputSelector).val(JSON.stringify(pdbs));
            // Update view
            $(pdbsCountSelector).html(pdbs.length);
          }  else if (mode=='Two groups of structures') {

            group = $(elem).closest('.tableview').attr('group-number');
            if (group) mode = mode + group;

            var pdbs = [];
            $('.pdb_selected:checked', oTable[mode].cells().nodes()).each(function() {
                pdbs.push($(this).attr('id'));
            });

            var pdbsInputSelector = '#two-crystal-groups-tab .crystal-group-'+group+'-pdbs';
            var pdbsCountSelector = '#two-crystal-groups-tab .crystal-count-'+group;
            $(pdbsInputSelector).val(JSON.stringify(pdbs));
            // Update view
            $(pdbsCountSelector).html(pdbs.length);
          } 
          update_text_in_modal();
        }

        function check_all(elem) {
          var mode = $('ul#mode_nav').find('li.active').find('a').text().trim();
          show_all = $(elem).prop("checked");


          if (mode=='Single group of structures') {
            var pdbs = [];

            // REMOVE EXISITING? Probably not, more logically that filtering adds more 
            // $('input', oTable.cells().nodes()).prop('checked',false); 

            if (show_all) {
              $('.pdb_selected:visible').prop("checked",true);
            } else {
              $('.pdb_selected:visible').prop("checked",false);
            }

            $('.pdb_selected:checked', oTable[mode].cells().nodes()).each(function() {
                pdbs.push($(this).attr('id'));
            });

            var pdbsInputSelector = '#single-crystal-group-tab .crystal-pdb';
            var pdbsCountSelector = '#single-crystal-group-tab .crystal-count';
            $(pdbsInputSelector).val(JSON.stringify(pdbs));
            // Update view
            $(pdbsCountSelector).html(pdbs.length);
          }  else if (mode=='Two groups of structures') {

            group = $(elem).closest('.tableview').attr('group-number');
            if (group) mode = mode + group;
            console.log(mode);
            var pdbs = [];

            if (show_all) {
              $('.pdb_selected:visible').prop("checked",true);
            } else {
              $('.pdb_selected:visible').prop("checked",false);
            }

            $('.pdb_selected:checked', oTable[mode].cells().nodes()).each(function() {
                pdbs.push($(this).attr('id'));
            });

            var pdbsInputSelector = '#two-crystal-groups-tab .crystal-group-'+group+'-pdbs';
            var pdbsCountSelector = '#two-crystal-groups-tab .crystal-count-'+group;
            $(pdbsInputSelector).val(JSON.stringify(pdbs));
            // Update view
            $(pdbsCountSelector).html(pdbs.length);
          } 

          update_text_in_modal();
        }
        
        $.fn.dataTable.ext.order['dom-checkbox'] = function  ( settings, col )
          {
              return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                  return $('input', td).prop('checked') ? '1' : '0';
              } );
          };

        var oTable = [];
        function showPDBtable(element) {
          var mode = $('ul#mode_nav').find('li.active').find('a').text().trim();
          console.log(mode);
          group = $(element+' .tableview').attr('group-number');
          if (group) mode = mode + group;
          console.log(mode);
          if ( ! $.fn.DataTable.isDataTable( element+' .tableview table' ) ) {
              oTable[mode] = $(element+' .tableview table').DataTable({
                'scrollX': true,
                // 'paging': true,
                // 'autoWidth': true,

                scrollY:        '80vh',
                // scrollCollapse: true,
                paging:         false,
                columnDefs: [
                  { targets: 'no-sort', orderable: false }
                ],
                "aaSorting": [],
                 "columns": [
                                null,
                                null,
                                null,
                                null,
                                null,
                                null,
                                null,
                                null,
                                { "orderDataType": "dom-checkbox" }
                            ]
              });

              yadcf.init(oTable[mode],
                [
                    {
                        column_number : 0,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Class",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        select_type_options: {
                          width: '70px'
                        },
                        filter_default_label: "PDB",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Receptor",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        html_data_type: "text",
                        select_type_options: {
                          width: '150px'
                        },
                        filter_default_label: "Family",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Species",
                        filter_reset_button_text: false,
                    }, 
                    {
                        column_number : 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        select_type_options: {
                            minimumResultsForSearch: -1 // remove search box
                        },
                        filter_default_label: "State",
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,

                    },
                    {
                        column_number : 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Representative",
                        filter_reset_button_text: false,

                    }, 
                ],
                {
                    cumulative_filtering: false
                }
            );

            yadcf.exResetAllFilters(oTable[mode]);

            oTable[mode].on('draw.dt', function (e, oSettings) {
                update_text_in_modal();
            });

          };
        }


        var stage = [];
        var color_schemes = [];
        var schemeId_grey
        function createNGLview(mode,pdb) {
            var gpcr_rep
            $("#ngl-"+mode).html("");
            stage[mode] = new NGL.Stage( "ngl-"+mode, { backgroundColor: "white" } );

            var pdb_data
            var original_o 
            blue_colors = ['#f7fcf0','#e0f3db','#ccebc5', '#a8ddb5',    '#7bccc4',    '#4eb3d3', '#2b8cbe',    '#0868ac',    '#084081']
            var reps = {} // store ngl representations

        

            $.getJSON( "pdb/"+pdb,
              function( data ) {

                pdb_data = data;
                color_schemes['blue'] = NGL.ColormakerRegistry.addSelectionScheme([
                        [blue_colors[1], pdb_data['segments']['TM1'].join(", ")],
                        [blue_colors[2], pdb_data['segments']['TM2'].join(", ")],
                        [blue_colors[3], pdb_data['segments']['TM3'].join(", ")],
                        [blue_colors[4], pdb_data['segments']['TM4'].join(", ")],
                        [blue_colors[5], pdb_data['segments']['TM5'].join(", ")],
                        [blue_colors[6], pdb_data['segments']['TM6'].join(", ")],
                        [blue_colors[7], pdb_data['segments']['TM7'].join(", ")],
                        [blue_colors[8], pdb_data['segments']['H8'].join(", ")],
                        [ "white", "*" ]
                        ])

                color_schemes['grey'] = NGL.ColormakerRegistry.addSelectionScheme([
                          ["#ccc", pdb_data['segments']['TM1'].join(", ")],
                          ["#bbb", pdb_data['segments']['TM2'].join(", ")],
                          ["#aaa", pdb_data['segments']['TM3'].join(", ")],
                          ["#888", pdb_data['segments']['TM4'].join(", ")],
                          ["#666", pdb_data['segments']['TM5'].join(", ")],
                          ["#444", pdb_data['segments']['TM6'].join(", ")],
                          ["#333", pdb_data['segments']['TM7'].join(", ")],
                          ["#111", pdb_data['segments']['H8'].join(", ")],
                          [ "white", "*" ]
                          ])


                var stringBlob = new Blob( [ pdb_data['pdb'] ], { type: 'text/plain'} );
                stage[mode].loadFile( stringBlob, { ext: "pdb" }  ).then( function( o ){
                    original_o = o
                    console.log(pdb_data['segments']['TM1'].join(", "))
                    


                    gpcr_rep = o.addRepresentation( "cartoon", {
                    sele: ":"+pdb_data['chain'], 
                    // radiusType: '',
                    radiusSize: 1,
                    radiusScale: 0.7, 
                    // color: "atomindex",
                    // colorScale: "Accent",
                    // color: "residueindex",
                    // colorScale: "greys",
                    color: color_schemes['grey'],
                    metalness: 0,
                    colorMode: "hcl",
                    roughness: 1,
                    opacity: 1,
                    depthWrite: true
                    });  

                    if (mode=='single') {
                      var links = []
                      var links_gn = []
                      var res_int = []
                      $('#single-crystal-tab rect[data-interaction-type]').each(function(e) {
                          var rect = $(this);
                          var resNo1 = rect.data('res-no-1');
                          var resNo2 = rect.data('res-no-2');
                          var seg1 = rect.data('seg-1');
                          var seg2 = rect.data('seg-2');
                          var genNo1 = rect.data('gen-no-1');
                          var genNo2 = rect.data('gen-no-2');
                          var aa1 = rect.data('aa-1');
                          var aa2 = rect.data('aa-2');
                          var iType = rect.data('interaction-type');
                          if (getInteractionStrength(iType)<3) return
                          res_int.push(resNo1);
                          res_int.push(resNo2);
                          links.push({"atoms": [resNo1+".CA",resNo2+".CA"], "data":{"color":getInteractionColor(iType)}})
                          console.log(genNo1,genNo2)
                          if ((genNo1=='-') || (genNo2=='-')) return
                          links_gn.push({"atoms": [resNo1+".CA",resNo2+".CA"], "data":{"color":getInteractionColor(iType)}})
                        });
                    }
                    console.log(links_gn);

                    var linkMap = {}
                    links.forEach(function (link) {
                      var atoms = link.atoms
                      linkMap[atoms[0].split(".")[0] + "-" + atoms[1].split(".")[0]] = link
                    })

                    var initColourSchemes = function () {
                      var linkColourScheme = function () {
                        this.bondColor = function (b) {
                          var origLink = linkMap[b.atom1.resno + "-" + b.atom2.resno]
                          if (origLink) {
                            // console.log('FOUND!',origLink,origLink.data.color);
                            r = origLink.data.color
                            return (r["r"] << 16) + (r["g"] << 8) + r["b"]
                          }
                          return (8 << 16) + (8 << 8) + 8 // (128 << 16) + (128 << 8) + 128 // grey default
                        }
                      }
                      reps.linkColourScheme = NGL.ColormakerRegistry.addScheme(linkColourScheme, "xlink")
                    }
                    initColourSchemes()

                    // return unique atom indices as a selection from a set of pairs of atom indices
                    // var makeAtomSelection = function (someLinks) {
                    //   var atomSet = new Set()
                    //   someLinks.forEach(function (link) {
                    //     atomSet.add(link.atoms[0].split(".")[0])
                    //     atomSet.add(link.atoms[1].split(".")[0])
                    //   })
                    //   var atomSelection = "(" + Array.from(atomSet).join(", ") + ") and .CA"
                    //   return atomSelection
                    // }
                    // var startAtomSel = makeAtomSelection(links)
                    // console.log(startAtomSel,"startAtomSel")


                    var baseLinkScale = 20
                    reps.links = o.addRepresentation("distance", {
                      atomPair: links.map(function (l) {
                        return l.atoms
                      }),
                      // colorValue: "yellow",
                      colorScheme: reps.linkColourScheme,
                      useCylinder: false,
                      labelVisible: false,
                      linewidth: 2
                    })
                    reps.links_gn = o.addRepresentation("distance", {
                      atomPair: links_gn.map(function (l) {
                        return l.atoms
                      }),
                      // colorValue: "yellow",
                      colorScheme: reps.linkColourScheme,
                      useCylinder: false,
                      labelVisible: false,
                      linewidth: 2,
                      visible: false
                    })

                    reps.int_res = o.addRepresentation( "spacefill", {
                      sele: ":"+pdb_data['chain']+" and ("+res_int.join(", ")+") and (.CA)", 
                      color: "red",
                      // colorScale: ["#44f", "#444"],
                      radiusScale: .2,
                      name: "res",
                      visible: false
                    });  


                    reps.ball_all = o.addRepresentation("ball+stick", {
                      sele: ":"+pdb_data['chain']+" and sidechainAttached",
                      visible: false
                      })

                    reps.ball = o.addRepresentation("ball+stick", {
                      sele: ":"+pdb_data['chain']+" and ("+pdb_data['only_gn'].join(", ")+") and sidechainAttached",
                      visible: false
                      })

                    reps.ball_int = o.addRepresentation("ball+stick", {
                      sele: ":"+pdb_data['chain']+" and ("+res_int.join(", ")+") and sidechainAttached",
                      visible: false
                      })


                    // reps.residues = o.addRepresentation("spacefill", {
                    //   sele: ".CA",
                    //   color: "#000",
                    //   // colorScale: ["#44f", "#444"],
                    //   radiusScale: .2,
                    //   name: "res"
                    // })


                    // reps.residues = o.addRepresentation("spacefill", {
                    //   sele: startAtomSel,
                    //   color: "#ccc",
                    //   // colorScale: ["#44f", "#444"],
                    //   radiusScale: .2,
                    //   name: "res"
                    // })


                    // o.addRepresentation( "distance", { 
                    //   atomPair: links.map(function (l) {
                    //     return l.atoms
                    //   }),
                    //   radiusScale: 1,
                    //   labelVisible: false,
                    //   useCylinder: true,
                    // } );


                    reps.ngl_contacts = o.addRepresentation("contact", {
                      sele: ":"+pdb_data['chain']+" and ("+pdb_data['only_gn'].join(", ")+")",
                      radiusSize: 0.07,
                      weakHydrogenBond: false,
                      waterHydrogenBond: false,
                      backboneHydrogenBond: false,
                      visible:false
                    })

                    o.autoView();


                } );

            });

            var newDiv = document.createElement("div");
            newDiv.setAttribute("style", "position: absolute; top: 50px; left: 20px")
            newDiv.innerHTML = '<div class="controls">'
                              +'<h3>Controls</h3>'
                              +'<p>Colors: <select id="ngl_color"><option value="grey">greys</option><option value="blue">blue</option></select></p>'
                              +'<p>Only GNs: <input type=checkbox id="ngl_only_gns"></p>'
                              +'<p>Highlight interacting res: <input type=checkbox id="highlight_res"></p>'
                              +'<p>Hide interaction lines: <input type=checkbox id="toogle_interactions"></p>'
                              +'<p>Show all side-chains: <input type=checkbox id="toggle_sidechains_all"></p>'
                              +'<p>Show GN side-chains: <input type=checkbox id="toggle_sidechains"></p>'
                              +'<p>Show GN side-chains (only interacting): <input type=checkbox id="toggle_sidechains_int"></p>'
                              +'<p>Show NGL derived contacts: <input type=checkbox id="ngl_contacts"></p>'
                              +'</div>';

            $("#ngl-single").append(newDiv);

            $("#"+mode+"-NGL-link").click(function(e){
                $(function() {
                  stage[mode].handleResize();
                });
            });


            $("#ngl-"+mode+" #ngl_color").change(function(e){
                console.log('changed color!',$(this).val(),"tothis");
                gpcr_rep.setParameters({
                  color: color_schemes[$(this).val()]
                });
            });

            $("#ngl-"+mode+" #ngl_only_gns").change(function(e){
                if ($(this).prop('checked')) {
                  sele = ":"+pdb_data['chain']+" and ("+pdb_data['only_gn'].join(", ")+")";
                  reps.links.setVisibility(false);
                  reps.links_gn.setVisibility(true);
                } else {
                  sele = ":"+pdb_data['chain'];
                  reps.links.setVisibility(true);
                  reps.links_gn.setVisibility(false);
                }
                gpcr_rep.setSelection(sele);
                original_o.autoView();
            });

            $("#ngl-"+mode+" #highlight_res").change(function(e){
                if ($(this).prop('checked')) {
                  reps.int_res.setVisibility(true);
                } else {
                  reps.int_res.setVisibility(false);
                }
            });

            $("#ngl-"+mode+" #toogle_interactions").change(function(e){
                if ($(this).prop('checked')) {
                  reps.links.setVisibility(false);
                  reps.links_gn.setVisibility(false);
                } else {
                  reps.links.setVisibility(true);
                }
            });

            $("#ngl-"+mode+" #toggle_sidechains_all").change(function(e){
                if ($(this).prop('checked')) {
                  reps.ball_all.setVisibility(true);
                } else {
                  reps.ball_all.setVisibility(false);
                }
            });

            $("#ngl-"+mode+" #toggle_sidechains").change(function(e){
                if ($(this).prop('checked')) {
                  reps.ball.setVisibility(true);
                } else {
                  reps.ball.setVisibility(false);
                }
            });

            $("#ngl-"+mode+" #toggle_sidechains_int").change(function(e){
                if ($(this).prop('checked')) {
                  reps.ball_int.setVisibility(true);
                } else {
                  reps.ball_int.setVisibility(false);
                }
            });

            $("#ngl-"+mode+" #ngl_contacts").change(function(e){
                if ($(this).prop('checked')) {
                  reps.ngl_contacts.setVisibility(true);
                } else {
                  reps.ngl_contacts.setVisibility(false);
                }
            });
            
        }

        $('#single-crystal-pdb-modal-table').on('shown.bs.modal', function (e) {
          showPDBtable('#single-crystal-pdb-modal-table');
        })
        $('#single-crystal-group-pdbs-modal-table').on('shown.bs.modal', function (e) {
          showPDBtable('#single-crystal-group-pdbs-modal-table');
        })
        $('#two-crystal-group-pdbs-modal-1-table').on('shown.bs.modal', function (e) {
          showPDBtable('#two-crystal-group-pdbs-modal-1-table');
        })
        $('#two-crystal-group-pdbs-modal-2-table').on('shown.bs.modal', function (e) {
          showPDBtable('#two-crystal-group-pdbs-modal-2-table');
        })


        function initializePdbChooserTables() {
          $.get('pdbtabledata', function ( data ) {
            $('#single-crystal-pdb-modal-table .tableview').html(data);
            $('#single-crystal-group-pdbs-modal-table .tableview').html(data);
            $('#two-crystal-group-pdbs-modal-1-table .tableview').html(data);
            $('#two-crystal-group-pdbs-modal-2-table .tableview').html(data);
            pdbtabledata = data;
          });
        }


        function initalizeSingleCrystalView() {
            initializeSegmentButtons('#single-crystal-tab');
            initializeGoButton('#single-crystal-tab', renderSingleCrystalHeatmap);
            initializeFullscreenButton('#single-crystal-tab');
        }

        function initializeSingleGroupCrystalView() {
            initializeSegmentButtons('#single-crystal-group-tab');
            initializeGoButton('#single-crystal-group-tab', renderSingleCrystalGroupHeatmap, true);
            initializeFullscreenButton('#single-crystal-group-tab');
            initializeInteractionButtons('#single-crystal-group-tab');
        }

        function initializeTwoCrystalGroupsView() {

            initializeSegmentButtons('#two-crystal-groups-tab');
            initializeGoButtonTwoCrystalGroups('#two-crystal-groups-tab', renderTwoCrystalGroupsHeatmap, true);
            initializeFullscreenButton('#two-crystal-groups-tab');
            initializeInteractionButtons('#two-crystal-groups-tab');
        }
        $(document).ready(function() {
            // Get PDBs for table build
            initializePdbChooserTables();

            // Single PDB files
            initalizeSingleCrystalView();

            // Single group of PDB files
            initializeSingleGroupCrystalView();

            // Two groups of PDB files
            initializeTwoCrystalGroupsView();
        });
    </script>
{% endblock %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <style type="text/css">
        .select2-result-label{
            font-size:x-small;
            font-size: 10px;
        }

        .no-top-border{
            border-top: 0px;
        }

        #filters{
            float:left;
          display:none;
          position:absolute; 
          background:white; 
          border: 1px solid #D1C9C2; 
          border-top: 1; 
          width: 400px; 
          margin: 0 auto; 
          padding:  7px 15px; 
          text-align: left; 
          -webkit-border-bottom-right-radius: 6px; 
          -webkit-border-bottom-left-radius: 6px; 
          -moz-border-radius-bottomright: 6px; 
          -moz-border-radius-bottomleft: 6px; 
          border-bottom-right-radius: 6px; 
          border-bottom-left-radius: 6px;
          z-index: 1;
            font-size: 10px;
        }

        @media (min-width: 1600px){
            #content {
                width: 1570px;
            }
        }
        @media (min-width: 1800px){
            #content {
                width: 1770px;
            }
        }
    </style>

    <style type="text/css">

        .modal-wide {
          width: 1200px;
        }

        .modal-footer {
            border-top: 0px;
        }

        #single-crystal-pdbs {
            height: 400px;
            overflow: scroll;
        }

        .heatmap {
            border: 1px lightslategrey solid;
            width: 100%;
            height: 500px;
        }

        @media screen and (max-width: 992px) {
            .go-button {
                width: 100%;
                margin-bottom: 15px;
            }
        }

        .heatmap-container {
            position: relative;
        }

        :-webkit-full-screen.heatmap-container {
          width: 100%;
          height: 100%;
          border: 0px;
        }

        :-webkit-full-screen.heatmap-container .heatmap {
          width: 100%;
          height: 100%;
          border: none;
        }

        .heatmap-legend {
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 5px;
            border: 1px dashed;
            background-color: white;
        }

        .heatmap-legend ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .heatmap-legend ul li {
            padding: 0;
            margin: 0;
        }

        .heatmap-legend ul li p {
            padding: 0;
            margin: 0;
            margin-left: 20px;
        }

        .heatmap-legend .color-box {
            width: 18px;
            height: 18px;
            float: left;
            margin-top: 2px;
        }

        .heatmap-legend input[type=checkbox] { 
            position: relative;
            bottom: 2px;
            left: 3px;
        }

        .heatmap-legend .temperature-scale .white-to-red {
            height: 10px;
            width: 100%;
            display: inline-block;
            background: -moz-linear-gradient(180deg, rgba(255,0,0,1) 0%, rgba(255,255,255,1) 100%); /* ff3.6+ */
            background: -webkit-gradient(linear, left top, right top, color-stop(0%, rgba(255,255,255,1)), color-stop(100%, rgba(255,0,0,1))); /* safari4+,chrome */
            background: -webkit-linear-gradient(180deg, rgba(255,0,0,1) 0%, rgba(255,255,255,1) 100%); /* safari5.1+,chrome10+ */
            background: -o-linear-gradient(180deg, rgba(255,0,0,1) 0%, rgba(255,255,255,1) 100%); /* opera 11.10+ */
            background: -ms-linear-gradient(180deg, rgba(255,0,0,1) 0%, rgba(255,255,255,1) 100%); /* ie10+ */
            background: linear-gradient(270deg, rgba(255,0,0,1) 0%, rgba(255,255,255,1) 100%); /* w3c */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#FFFFFF', endColorstr='#FF0000',GradientType=1 );
        }

        .heatmap-legend .temperature-scale .red-to-white {
            height: 10px;
            width: 50%;
            display: inline-block;
            background: -moz-linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,0,0,1) 100%); /* ff3.6+ */
            background: -webkit-gradient(linear, left top, right top, color-stop(0%, rgba(255,0,0,1)), color-stop(100%, rgba(255,255,255,1))); /* safari4+,chrome */
            background: -webkit-linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,0,0,1) 100%); /* safari5.1+,chrome10+ */
            background: -o-linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,0,0,1) 100%); /* opera 11.10+ */
            background: -ms-linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,0,0,1) 100%); /* ie10+ */
            background: linear-gradient(270deg, rgba(255,255,255,1) 0%, rgba(255,0,0,1) 100%); /* w3c */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#FF0000', endColorstr='#FFFFFF',GradientType=1 );
        }

        .heatmap-legend .temperature-scale .white-to-blue {
            height: 10px;
            width: 50%;
            display: inline-block;
            background: -moz-linear-gradient(180deg, rgba(0,0,255,1) 0%, rgba(255,255,255,1) 100%); /* ff3.6+ */
            background: -webkit-gradient(linear, left top, right top, color-stop(0%, rgba(255,255,255,1)), color-stop(100%, rgba(0,0,255,1))); /* safari4+,chrome */
            background: -webkit-linear-gradient(180deg, rgba(0,0,255,1) 0%, rgba(255,255,255,1) 100%); /* safari5.1+,chrome10+ */
            background: -o-linear-gradient(180deg, rgba(0,0,255,1) 0%, rgba(255,255,255,1) 100%); /* opera 11.10+ */
            background: -ms-linear-gradient(180deg, rgba(0,0,255,1) 0%, rgba(255,255,255,1) 100%); /* ie10+ */
            background: linear-gradient(270deg, rgba(0,0,255,1) 0%, rgba(255,255,255,1) 100%); /* w3c */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#FFFFFF', endColorstr='#0000FF',GradientType=1 );
        }

        .flareplot-container {
            position: relative;
        }

        :-webkit-full-screen.flareplot-container {
          width: 100%;
          height: 100%;
          border: 0px;
        }

        :-webkit-full-screen.flareplot-container .heatmap {
          width: 100%;
          height: 100%;
          border: none;
        }

        #single-crystal-tab .panel .btn-primary:hover, #single-crystal-group-tab .panel .btn-primary:hover, #two-crystal-groups-tab .panel .btn-primary:hover {
            background-color: #337ab7;
        }

        #single-crystal-tab .panel .btn-primary.active:hover, #single-crystal-group-tab .panel .btn-primary.active:hover, #two-crystal-groups-tab .panel .btn-primary.active:hover {
            background-color: #286090;
        }

                #single-crystal-tab .panel .btn-primary:focus, #single-crystal-group-tab .panel .btn-primary:focus, #two-crystal-groups-tab .panel .btn-primary:focus {
            background-color: #337ab7;
        }

        #single-crystal-tab .panel .btn-primary.active:focus, #single-crystal-group-tab .panel .btn-primary.active:focus, #two-crystal-groups-tab .panel .btn-primary.active:focus {
            background-color: #286090;
        }

        .svg-download-button {
            margin-top: 6px;
        }

        .csv-download-button {
            margin-top: 6px;
        }
    </style>

    <!-- NGL -->
    <script type="text/javascript" src="https://cdn.rawgit.com/arose/ngl/v2.0.0-dev.32/dist/ngl.js"> </script>

    <!-- Flareplot -->
    <script type="text/javascript" src="{% static 'home/js/GPCRdb2flare.js' %}"> </script>

    <!-- 2D schematics -->

    <script type="text/javascript" src="{% static 'home/js/schematicplot.js' %}"> </script>
    
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"> </script>

    <!-- TODO: Solve the conflict between flareplot-main.js and the existing PDB selector -->
    <script type="text/javascript" src="{% static 'home/js/flareplot-main.js' %}"> </script>
    <script type="text/javascript" src="{% static 'home/js/flareplot-selectors.js' %}"> </script>
    <script type="text/javascript" src="{% static 'home/js/flareplot-rangeslider.js' %}"> </script>

    <link href="{% static 'home/css/flareplot-main.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/flareplot-selectors.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/flareplot-rangeslider.css' %}" rel="stylesheet">

    <style>
        .flareplot-container div{
            position: relative;
            left: 50%;
            margin-left: -300px;
        }
        #sliderDiv {
            height: 30px;
            width: 600px;
            position: relative;
            left: 50%;
            margin-left: -300px;
            margin-top: 20px;
        }
        #regroupDiv {
            position: relative;
            left: 50%;
            margin-left: -50px;
            margin-top: 20px;
            width: 100px;
            height: 30px;
            background-color: #d7deeb;
            vertical-align: middle;
            text-align: center;
            line-height: 30px;
            border: 2px solid #8489a3;
            cursor: pointer;
            border-radius: 5px;
        }
        #regroupDiv:hover {
            background-color: #a1a5bd;
        }
    </style>



{% endblock %}