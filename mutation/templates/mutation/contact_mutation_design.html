{% extends "home/base.html" %}
{% load static %}
{% block addon_css %}

<link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
<link href="{% static 'home/css/buttons.dataTables.min.css' %}" rel="stylesheet">

<style type="text/css">
    div.dt-buttons {
      clear: both;
    }

    table#suglist1, table#suglist2 {
      width: 100%;
    }
</style>

{% endblock %}
{% block content %}

<ul class="nav nav-tabs nav-browsers">
  {% if freq_results1 %}
    <li class="active"><a href="#mutation-table-1-tab" data-toggle="tab" id="mutation-table-1-tab-link">1. Removing {{ undesired }} stabilizing AAs</a></li>
  {% endif %}

  {% if freq_results2 %}
    {% if freq_results1 %}
      <li>
    {% else %}
      <li class="active">
    {% endif %}

    <a href="#mutation-table-2-tab" data-toggle="tab" id="mutation-table-2-tab-link">2. Introducing {{ desired }} stabilizing AAs</a></li>
  {% endif %}
</ul>

<div class="row">
  <div class="tab-content col-md-12 ">
    {% if freq_results1 %}
      <div class="tab-pane active" id="mutation-table-1-tab">
          <div class="panel panel-default">
              <div class="panel-heading">
                  <h3 class="panel-title pull-left">Mutations to destabilize the <i>{{ undesired }}</i></h3>
                  <span class="pull-right">
                      <span class="glyphicon glyphicon-download btn-download"></span><span class="glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                  </span>
                  <div class="clearfix"></div>
              </div>
              <div class="panel-body">
                <table class="display compact" id="suglist1">
                  <thead>
                    <tr>
                      <th rowspan=2>Target<br>residue<br>number</th>
                      <th rowspan=2>Generic<br>residue<br>number</th>
                      <th rowspan=2>Target<br>WT AA</th>
                      <th rowspan=2><span class="text-red-highlight">Mutant AA</span><br>Ala<br>(removes sidechain)</th>
                      <th colspan=4 class="text-center">Sum of residue contact frequencies</th>
                      <th rowspan=1 colspan=2 class="text-center">Class conservation</th>
                      <th rowspan=1 colspan=2 class="text-center">Mutation data</th>
                      <th rowspan=1 colspan=3 class="text-center">Thermostabilizing mutations</th>
                    </tr>
                    <tr>
                      <!--<th rowspan=2>Ala<br>(removes<br>sidechain)</th>
                      <th colspan=2>Reversed polarity<br>(repels contact)</th>-->
                      <th rowspan=1>Diff</th>
                      <th rowspan=1>Diff<br>ratio</th>
                      <th rowspan=1>{{ desired }}</th>
                      <th rowspan=1>{{ undesired }}</th>
                      <th rowspan=1>AA</th>
                      <th rowspan=1>%</th>
                      <th rowspan=1>&#8805;5-fold&nbsp;effect<br># mut.</th>
                      <th rowspan=1>all<br># mut.</th>
                      <th rowspan=1>In same<br>pos.</th>
                      <th rowspan=1>Same<br>WT AA</th>
                      <th rowspan=1>Same<br>mutant AA</th>
                    </tr>
                    <!--<tr>
                      <th>#1</th>
                      <th>#2</th>
                    </tr>-->
                  </thead>
                  <tbody>
                    {% for gn, entry in freq_results1.items %}
                    <tr data-generic_gn="{{ gn }}">
                      {% for data in entry %}
                      <td>{{ data | safe}}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
          </div>
      </div>
    {% endif %}
    {% if freq_results2 %}
      {% if freq_results1 %}
        <div class="tab-pane" id="mutation-table-2-tab">
      {% else %}
        <div class="tab-pane active" id="mutation-table-2-tab">
      {% endif %}
          <div class="panel panel-default">
              <div class="panel-heading">
                  <h3 class="panel-title pull-left">Mutations to stabilize the <i>{{ desired }}</i></h3>
                  <span class="pull-right">
                      <span class="glyphicon glyphicon-download btn-download"></span><span class="glyphicon glyphicon-fullscreen btn-fullscreen"></span>
                  </span>
                  <div class="clearfix"></div>
              </div>
              <div class="panel-body">
                <table width="100%" class="display compact" id="suglist2">
                  <thead>
                    <tr>
                      <th rowspan=2>Target<br>residue<br>number</th>
                      <th rowspan=2>Generic<br>residue<br>number</th>
                      <th rowspan=2>Target<br>WT AA</th>
                      <th colspan=2 class="text-center"><span class="text-red-highlight">Mutant AA</span><br>({{ desired }} conservation)</th>
                      <th colspan=4 class="text-center">Sum of residue contact frequencies</th>
                      <th rowspan=1 colspan=2 class="text-center">Class conservation</th>
                      <th rowspan=1 colspan=2 class="text-center">Mutation data</th>
                      <th rowspan=1 colspan=3 class="text-center">Thermostabilizing mutations</th>
                    </tr>
                    <tr>
                      <th rowspan=1>AA</th>
                      <th rowspan=1>%</th>

                      <!--<th rowspan=1>Ala<br>(removes<br>sidechain)</th>
                      <th colspan=1>Reversed polarity<br>(repels contact)</th>-->
                      <th rowspan=1>Diff</th>
                      <th rowspan=1>Diff<br>ratio</th>
                      <th rowspan=1>{{ desired }}</th>
                      <th rowspan=1>{{ undesired }}</th>
                      <th rowspan=1>AA</th>
                      <th rowspan=1>%</th>
                      <th rowspan=1>&#8805;5-fold&nbsp;effect<br># mut.</th>
                      <th rowspan=1>all<br># mut.</th>
                      <th rowspan=1>In same<br>pos.</th>
                      <th rowspan=1>Same<br>WT AA</th>
                      <th rowspan=1>Same<br>mutant AA</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for gn, entry in freq_results2.items %}
                    <tr data-generic_gn="{{ gn }}">
                      {% for data in entry %}
                      <td>{{ data | safe}}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
          </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal -->
<div class="modal" id="detailGNModal" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title"></h4>
      </div>

      <div class="modal-body">

      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block addon_js %}
<!--<script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>-->
<script src="{% static 'home/js/dataTables.min.js' %}"> </script>
<script src="{% static 'home/js/dataTables.buttons.min.js' %}"> </script>
<script src="{% static '/home/js/grayscale.js' %}"> </script>


<script type="text/javascript" charset="utf-8">
  var table_options = {"paging":        true,
                        "pageLength":   20,
                        "lengthChange": false,
                        "ordering":     false,
                        "searching":    false,
                        "buttons":      ["csv", "excel"],
                        "dom":          "lfrtipB",
                      }

  $(document).ready(function() {
    // Init mutations table 1
    if ($("#suglist1").length > 0){
      // Assign coloring class to each cell in freq. diff table
      // NOTE: Adjust color index when changing table - currently 8
      $("#suglist1 tbody tr td").filter(":nth-child(5), :nth-child(6)").each( function() {
          $(this).addClass("color-column");
          $(this).addClass("color-reverse");
          //$(this).on("click", detailGN);
      });

      $("#suglist1 tbody tr").each( function() {
          $(this).on("click", detailGN);
      });

      gray_scale_table($("#suglist1"));

      var table_options1 = Object.assign({}, table_options);
      table_options1["columnDefs"] = [
          { className: "text-center", "targets": [ 0,1,2,3,4,5,7,8,9, 12,13,14 ] }
        ]
      var table1 = $("#suglist1").DataTable(table_options1);
    }

    // Init mutations table 2
    if ($("#suglist2").length > 0){
      // Assign coloring class to each cell in freq. diff table
      // NOTE: Adjust color index when changing table - currently 8
      $("#suglist2 tbody tr td").filter(":nth-child(6), :nth-child(7)").each( function() {
          $(this).addClass("color-column");
          //$(this).on("click", detailGN);
          //$(this).addClass("color-reverse");
      });

      $("#suglist2 tbody tr").each( function() {
          $(this).on("click", detailGN);
      });

      gray_scale_table($("#suglist2"));

      var table_options2 = Object.assign({}, table_options);
      table_options2["columnDefs"] = [
          { className: "text-center", "targets": [ 0,1,2,3,4,5,7,8,9,10, 13,14,15 ] }
        ]
      var table2 = $("#suglist2").DataTable(table_options2);
    }
  });

  function detailGN(event) {
    var row = $(event.target).closest("tr")[0];
    var gn = $(row).attr("data-generic_gn");

    //Dealing with csrf token
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }
    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });

    // Ajax query to backend and populate a modal
    $.ajax({
        'url': '/mutations/design_state_detail_gn',
        'data': {
            "gn": gn
        },
        'type': 'POST',
        'async': false,
        'success': function (data) {
            $("#detailGNModal .modal-title").text("Contact frequencies for " + gn)
            $("#detailGNModal .modal-body").html(data)
            $('#detailGNModal').modal('show');
            gray_scale_table($("#detailGNModal table"));
            $('#detailGNModal table').DataTable({
              "order": [[ 3, "desc" ]],
              "paging":        true,
              "pageLength":   15,
              "lengthChange": false,
              "searching":    false,
            });
        }
    });
  }
</script>
{% endblock %}
