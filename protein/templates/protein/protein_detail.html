{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}


{% block content %}

{% if protein_no_found %}
<br><br>
<div class="row text-success">
    <div class="text-center">
        <h2>{{ protein_no_found|safe }} not in GPCRdb - contact us if it should be.</h2>
    </div>
</div>
{% else %}

<div class="row text-success">
    <div class="text-center">
        <h2>{{ p.name|safe }} ({{ p.entry_name }})</h2>
    </div>
</div>

{% include "protein/protein_info.html" %}

{% include "protein/sequence_viewer.html" %}

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>LINKS</h4>
    </div>
    <div class="col-md-10">
        {% for link in protein_links %}
        <p><a href="{{ link }}">{{ link.web_resource.name }}</a></p>
        {% empty %}
        No links available
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>DIAGRAMS</h4>
    </div>
    <div class="col-md-10">
    {{ p.get_helical_box }}
    <p><div class="btn-group">
        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false">
        <span class="glyphicon glyphicon-download"></span> Download <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
        <li>
            <a href="javascript:saveSvgAsPng(document.getElementById('helixbox'), 'helixbox_{{ p.entry_name }}.png',
            {scale: 3});">PNG</a>
        </li>
        <li>
            <a href="javascript:saveSvgAsJpg(document.getElementById('helixbox'), 'helixbox_{{ p.entry_name }}.jpg',
            {scale: 3});">JPG</a>
        </li>
        <li>
            <a href="javascript:saveSvgAsTiff(document.getElementById('helixbox'), 'helixbox_{{ p.entry_name }}.tiff',
            {scale: 3});">TIFF</a>
            </a>
        </li>
        <li>
        <a id=helix_svg_link href-lang="image/svg+xml" href="" download="helixbox_{{ p.entry_name }}">SVG</a>
        </li>
        </ul>
    </div></p>
    {{ p.get_snake_plot }}
    <p><div class="btn-group">
        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false">
        <span class="glyphicon glyphicon-download"></span> Download <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
        <li>
            <a href="javascript:saveSvgAsPng(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.png',
            {scale: 3});">PNG</a>
        </li>
        <li>
            <a href="javascript:saveSvgAsJpg(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.jpg',
            {scale: 3});">JPG</a>
        </li>
        <li>
            <a href="javascript:saveSvgAsTiff(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.tiff',
            {scale: 3});">TIFF</a>
            </a>
        </li>
        <li>
        <a id=snake_svg_link href-lang="image/svg+xml" href="" download="snake_{{ p.entry_name }}">SVG</a>
        </li>
        </ul>
    </div></p>
    </div>
</div>

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>MUTATIONS</h4>
    </div>
    <div class="col-md-10">
    <a href="/mutations/protein/{{ p }}">{{ mutations|length }} mutation data points available.</a>
    </div>
</div>

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>ENDOGENOUS LIGANDS</h4>
    </div>
    <div class="col-md-10">
        {% for e in p.endogenous_ligands.all %}
        <p style="display: inline;">{{ e.name|safe }}{% if forloop.last %}{% else %}, {% endif %}</p>
        {% empty %}
        No endogenous ligands available
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>HOMOLOGY MODELS</h4>
    </div>

    <div class="col-md-10">
        {% for hommod in homology_models %}
            <p style="display: inline;"><a href="/structure/homology_models/{{ hommod.protein.entry_name }}_{{ hommod.state.slug }}">{{ hommod.protein.entry_name }} {{ hommod.state.slug }}</a>{% if forloop.last %} {% else %}, {% endif %}</p>
        {% empty %}
        No homology models available. Check the Archive on <a href="/structure/homology_models">Structure models</a> for earlier releases.
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-2 text-right text-info">
        <h4>STRUCTURES</h4>
    </div>
    {% if structures|length > 0 %}
    <!-- scrollable column -->
    <div style='padding-top: 0px; font-size: 10px; white-space: nowrap; width:100%; overflow-y:hidden; display:inline-block; width:100%;'>
        <!-- <div class='wrapper' style='height:20px;width:100%;'>
            <div style='height:20px;width:3000px;'></div>
        </div> -->
        <div id='structures_scrollable_div'>
            <table class="display compact text-nowrap" id='structures_scrollable'>
                <thead>
                    <tr class='over_header over_header_row'>
                        <th colspan=6 class="over_header">
                            <div>
                                <div class='overhead_text'>RECEPTOR</div>
                            </div>
                        </th>
                        <th colspan=7 class="over_header flexible_over_header" id='structure_over_header' >
                            <div>
                                <div class='overhead_text'>STRUCTURE</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="6,7,8,9,10,11,12"  aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=4 class="over_header flexible_over_header" id='sign_prot_over_header'>
                            <div>
                                <div class='overhead_text'>SIGNAL PROTEIN</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="13,14,15,16" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='aux_prot_over_header'>
                            <div>
                                <div class='overhead_text'>AUXILIARY PROTEIN</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="17,18" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=3 class="over_header flexible_over_header" id='structure_ligand_over_header'>
                            <div class='overhead_text'>STRUCTURE LIGAND</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="19,20,21" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='endo_ligand_over_header'>
                            <div class='overhead_text'>ENDOGENOUS LIGAND</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="22,23" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='sodium_over_header'>
                            <div class='overhead_text'>SODIUM ION SITE</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="24,25" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=3 class="over_header flexible_over_header" id='reference_over_header'>
                            <div class='overhead_text'>REFERENCE</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="26,27,28" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                        <th colspan=1 class="over_header flexible_over_header" id='annotated_over_header'>
                            <div class='overhead_text'>ANNOTATED</div>
                                <div class='overhead_close'>
                                    <button type="button" class="close hide_columns" columns="29," style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                </div>
                            </div>
                        </th>
                    </tr>
                    <tr class='over_header'>
                        <th></th>
                        <th>
                            <div>
                                <div>UniProt</div>
                                <div><button class='icon-button' type='button'><i id='uniprot_copy' class="glyphicon glyphicon-export uniprot-export"></i></button></div>
                            </div>
                        </th>
                        <th>IUPHAR</th>
                        <th>Receptor family</th>
                        <th>Class</th>
                        <th class='rightborder'>Species</th>
                        <th>Method</th>
                        <th>
                            <div>
                                <div>PDB</div>
                                <div><button class='icon-button' type='button'><i id='pdb_copy' class="glyphicon glyphicon-export pdb-export"></i></button></div>
                            </div>
                        </th>
                        <th><a href="https://academic.oup.com/nar/article/44/D1/D356/2502664" target="_blank">Refined<br>structure</a></th>
                        <th>Resolution</th>
                        <th>Preferred<br>chain</th>
                        <th>State</th>
                        <th class='rightborder'>Degree<br>active (%)</th>
                        <th>Family</th>
                        <th>Subtype</th>
                        <th>Note</th>
                        <th class='rightborder'>% of Seq</th>
                        <th>Fusion</th>
                        <th class='rightborder'>Antibodies</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th class='rightborder'>Function</th>
                        <th>Name</th>
                        <th class='rightborder'>Type</th>
                        <th>D2x50-S3x39</th>
                        <th class='rightborder'>Sodium in structure</th>
                        <th>Last author</th>
                        <th>Reference</th>
                        <th class='rightborder'>PDB Date</th>
                        <th class='rightborder'></th>
                    </tr>
                    <tr>
                        <th class='no-sort checkbox_tr'><input class="select-all" type="checkbox" onclick="select_all(this)"></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th class='rightborder'></th>
                    </tr>

                </thead>
                <tbody>
                {% for structure in structures.all %}
                    {% if structure.representative %}
                        <tr class="repr-st" model_id='{{structure.pk}}'>
                    {% else %}
                        <tr model_id='{{structure.pk}}'>
                    {% endif %}
                        <td class="text-center"><input class="alt" type="checkbox" id="{{ structure.pk }}"></td>
                        <td><span><a href="http://www.uniprot.org/uniprot/{{ structure.protein_conformation.protein.parent.accession }}">{{ structure.protein_conformation.protein.parent.entry_short|safe }}</a></span></td>
                        <td class='uniprot'><a href="/protein/{{ structure.protein_conformation.protein.parent.entry_name }}">{{ structure.protein_conformation.protein.parent.short|safe }}</a></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.short|safe }}</span></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.parent.parent.short|safe }}</span></td>
                        <td>{{ structure.protein_conformation.protein.species.common_name }}</td>
                        <td>
                            {{ structure.structure_type.type_short|escape }}
                        </td>
                        <td class="pdb text-left">
                            <a href="{{ structure.pdb_code.index}}">{{ structure.pdb_code.index}}</a>
                        </td>
                        <td>
                            {% if structure.is_refined %}
                            <a href="homology_models/{{ structure.pdb_code.index }}_refined">{{structure.pdb_code.index}}_refined</a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">{{ structure.resolution|floatformat:"1" }}</td>
                        <td class="text-center">{{ structure.preferred_chain }}</td>
                        <td>{{ structure.state.name }}</td>
                        <td class="text-center">{{ structure.gprot_bound_likeness|floatformat }}</td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {% if ep.category == "Arrestin" %}
                                    {{ ep.wt_protein.family.parent.parent.name }}
                                {% else %}
                                    {{ ep.wt_protein.family.parent.name }}
                                {% endif %}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {{ ep.display_name}}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {% if ep.note is None %}
                                    -
                                {% else %}
                                    {% if ep.note|length > 20 %}
                                        <span title="{{ ep.note }}">{{ ep.note|cut_at_20 }}...</span>
                                    {% else %}
                                    {{ ep.note }}
                                    {% endif %}
                                {% endif %}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {% if ep.wt_coverage != None %}
                                    {{ ep.wt_coverage}}
                                {% else %}
                                    -
                                {% endif %}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_fusions|linebreaksbr }}
                        </td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_antibodies|linebreaksbr }}
                        </td>
                        <td>
                            {% for ligand in structure.ligands.all %}
                                {% if ligand.ligand.name|safe|length > 20 %}
                                    <span title="{{ ligand.ligand.name|safe }}">{{ ligand.ligand.name|safe|cut_at_20 }}...</span>
                                {% else %}
                                    {{ ligand.ligand.name|safe }}
                                {% endif %}
                            {% for link in ligand.ligand.properities.web_links.all %}
                                <a href="{{ link}}" target="_blank">{{link.web_resource.slug}}</a>
                            {% endfor %}
                                <br />
                            {% empty %}
                                N/A
                            {% endfor %}
                        </td>
                        <td>
                            {{ structure.ligands.all|ligandtype|linebreaksbr }}
                        </td>
                        <td>
                            {{ structure.ligands.all|ligandrole|linebreaksbr }}
                        </td>
                        <td>
                            {% autoescape off %}
                            {% if structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat|length > 20 %}
                                <span title="{% autoescape off %}{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat }}{% endautoescape %}">{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat|cut_at_20 }}...</span>
                            {% else %}
                                {{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat }}
                            {% endif %}
                            {% endautoescape %}
                        </td>
                        <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all.0.properities.ligand_type }}</td>
                        <td>
                            {% if structure.protein_conformation.is_sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {% if structure.sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {{ structure.publication.authors|last_author}}
                        </td>
                        <td>
                            <a href="{{ structure.publication.web_link }}">
                            {{ structure.publication.web_link.index }}
                            </a>
                        </td>
                        <td>{{ structure.publication_date|date:"Y-m-d" }}</td>
                        <td>
                            {% if structure.annotated %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="col-md-10">
       <!--  {% for structure in structures %}
        <p style="display: inline;"><a href="/structure/{{ structure.pdb_code.index }}">{{ structure.pdb_code.index }}</a>{% if forloop.last %} {% else %}, {% endif %}</p>
        {% empty %} -->
        No structures available
        <!-- {% endfor %} -->
    </div>
    {% endif %}
</div>

{% endif %}
{% endblock %}


{% block addon_css %}
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/color_picker.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/structure_browser.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/modal.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'home/css/jquery.powertip.css' %}" />
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/sequenceviewer.js' %}"></script>
    <script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
    <script src="{% static 'home/js/diagrams.js' %}"></script>
    <script src="{% static 'home/js/color_picker.js' %}"></script>
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/alignment.js' %}"> </script>
    <script src="{% static 'home/js/browser_functions.js' %}"> </script>
    <script src="{% static 'home/js/structure_browser.js' %}"> </script> <!-- Structure browser-->
    <script src="{% static 'home/js/jquery.powertip.js' %}"></script>

<script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        structurebrowser();
    });
</script>

{% endblock %}

