{% extends "home/base.html" %}
{% load staticfiles %}
{% load structure_extras %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/modal.css' %}" rel="stylesheet">
    <style type="text/css">
        .select2-result-label{
            font-size:x-small;
            font-size: 10px;
        }

        #filters{

            font-size: 10px;
            padding:  7px 15px; 
        }

        @media (min-width: 1600px){
            #content {
                width: 1570px;
            }
        }
        @media (min-width: 1800px){
            #content {
                width: 1770px;
            }
        }

        table.dataTable.compact thead th.over_header {
            border-right: 1px solid;
            border-left: 0px solid;
            text-align: center;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead tr.over_header th {
            border-bottom: 1px solid #ccc;
        }

        table.dataTable.compact thead th.leftborder {
            border-left: 1px solid;
        }

        table.dataTable.compact thead th.rightborder {
            border-right: 1px solid;
        }

        table.dataTable.compact thead th.checkbox_tr {
            text-align: left;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead th {
            padding: 4px 16px 4px 2px;
        }
        .yadcf-filter-wrapper {
            margin-top: 0px;
        }
        input.yadcf-filter  {
            width: 100px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }
        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }
        
    }
    </style>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/alignment.js' %}"> </script>
    <script src="{% static 'home/js/browser_functions.js' %}"> </script>


    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            // 'use strict';

            var oTable2 = $('#structures_frozen').DataTable({
                "scrollY":        "80vh",
                "scrollX":        false,
                "scrollCollapse": true,
                "scroller": true,
                "paging":         false,
                "autoWidth": false,
                "order": [[4,'desc'],[1,'asc']],
            });


            var oTable = $('#structures_scrollable').DataTable({
                "scrollY":        "80vh",
                "scrollX":        true,
                "scrollCollapse": true,
                "scroller": true,
                "paging":         false,
                "autoWidth": false,
                // fixedColumns:   {
                //     leftColumns: 4
                // },
                "order": [[26,'desc'],[1,'asc']],
                "columnDefs": [
                    { "targets": 'no-sort', "orderable": false }
                    ],
                "columns": [
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    {"width": "20%"},
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null
                ],
                // "dom": 'iTlfrt',
                // "tableTools": {
                //     "sRowSelect": "single",
                //     "aButtons": []
                // },
                "bInfo" : false,
            });

            var prev_ids = Array()
            var current_align_ids = Array()

            //Uncheck every row when using back button on browser
            $('.alt-selected').prop('checked',false)
            $('.alt').prop('checked',false)
            $('.select-all').prop('checked',false)
            //

            $("#structures_div").show();

            assign_to_row();
            $("#loading_div").hide();

            // yadcf.init(oTable2,
            //     [
            //         {
            //             column_number : 1,
            //             filter_type: "multi_select",
            //             select_type: 'select2',
            //             column_data_type: "html",
            //             html_data_type: "text",
            //             filter_default_label: "UniProt",
            //             filter_match_mode : "exact",
            //             filter_reset_button_text: false,
            //             select_type_options: {
            //                 width: '60px',
            //             }
            //         },
            //         {
            //             column_number : 2,
            //             filter_type: "multi_select",
            //             select_type: 'select2',
            //             column_data_type: "html",
            //             html_data_type: "text",
            //             filter_default_label: "IUPHAR",
            //             filter_match_mode : "exact",
            //             filter_reset_button_text: false,
            //             select_type_options: {
            //                 width: '80px',
            //             }
            //         },
            //         {
            //             column_number : 3,
            //             filter_type: "multi_select",
            //             select_type: 'select2',
            //             column_data_type: "html",
            //             html_data_type: "text",
            //             filter_default_label: "Rec. family",
            //             filter_match_mode : "exact",
            //             filter_reset_button_text: false,
            //             select_type_options: {
            //                 width: '120px',
            //             }
            //         },
            //         {
            //             column_number : 4,
            //             filter_type: "range_date",
            //             date_format: "yyyy-mm-dd",
            //             select_type: 'select2',
            //             filter_default_label: ["From", "To"],
            //             filter_reset_button_text: false,
            //         },
            //     ],
            //     {
            //         cumulative_filtering: false
            //     }
            // );

            yadcf.init(oTable,
                [
                    {
                        column_number : 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "UniProt",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "IUPHAR",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Rec. family",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '120px',
                        }
                    }, 
                    {
                        column_number: 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Class",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number: 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Species",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    }, 
                    {
                        column_number : 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        // filter_default_label: "PDB code",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    }, 
                    {
                        column_number : 7,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        // filter_default_label: "Refined",
                        column_data_type: "html",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 8,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 9,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Pre. chain",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 10,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "State",
                        filter_reset_button_text: false,
                        filter_match_mode : "exact",
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    
                    {
                        column_number : 11,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 12,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "G-protein",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 13,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Arrestin",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 14,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Fusion",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 15,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Antibodies",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 16,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Endo. ligand",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 17,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Ligand type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 18,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Structure ligand",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 19,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Structure lig. function",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '120px',
                        }
                    },
                    {
                        column_number : 20,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Structure lig. type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 21,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Method",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 22,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "D2x50-S3x39",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number : 23,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Sodium in structure",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 24,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Senior author",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 25,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Reference",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '140px',
                        }
                    },
                    {
                        column_number : 26,
                        filter_type: "range_date",
                        date_format: "yyyy-mm-dd",
                        select_type: 'select2',
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number : 27,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Annotated",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    }
                ],
                {
                    cumulative_filtering: false
                }
            );

            match_rowheight();
            var frozen_ids = get_row_ids('structures_frozen');
            var scrollable_ids = get_row_ids('structures_scrollable');
            oTable2 = reorder_table(scrollable_ids, frozen_ids, oTable2);
            oTable2.draw();

            yadcf.exResetAllFilters(oTable);


            // $.datepicker.regional[""].dateFormat = "yy-mm-dd";
            // $.datepicker.setDefaults($.datepicker.regional['']);

            // $('#structures tbody').on( 'click', 'tr', function () {
            //     if ( $(this).hasClass('selected') ) {
            //         $(this).removeClass('selected');
            //     }
            //     else {
            //         oTable.$('tr.selected').removeClass('selected');
            //         $(this).addClass('selected');
            //     }
            // } );
         
            $('.alt').change(function () {
                $(this).parent().parent().toggleClass('alt_selected');
            });

            $('.select-all').change(function () {
                $('.alt').prop('checked', $(this).prop("checked"));
                $('.alt').parent().parent().toggleClass('alt_selected');
            });

            $("#remove_sel").click(function () { 
                var oTable = $('#structures').dataTable();
                $('input:checkbox:checked').each(function () {
                    if ( $(this).is(':visible') ) {
                       id = $(this).attr('id');

                       if (id) {
                           oTable.fnDeleteRow("#"+id, null, false);
                       }
                    }
                });
               oTable.fnDraw();
            });

            $("#remove_non_sel").click(function () { 
                var oTable = $('#structures').dataTable();
                $('input:checkbox:not(:checked)').each(function () {
                    if ( $(this).is(':visible') ) {
                       id = $(this).attr('id');
                       if (id) {
                           oTable.fnDeleteRow("#"+id, null, false);
                       }
                   }
                });
                oTable.fnDraw();
            });

            $('#apply_filter').click(function() {
                // $("#filters").toggle();
            });

            $("#OpenFilters").click(function () {
                // $("#filters").toggle();
            });

            $('.slider').slider({
              min: 30,
              max: 200,
              value: 70,
              change: function( event, ui ) {
                console.log(ui.value);
                $(".schematic-block").width(ui.value);
              }
            });

            $('[data-toggle="tooltip"]').tooltip({ container: 'body' })
            $('.table_tooltip').tooltip({ container: 'body', html: true, placement: "top"})


            $('.column_toggle').click(function(evt) {
                console.log('start toggle');
                // evt.stopPropagation();
                // evt.stopImmediatePropagation();
                // evt.preventDefault();
                columns = $(this).attr('data-column').split(",");
                // var checked = this.checked;
                // var checked = (this.checked ? false : true);
                columns.forEach(function(column) {
                    // console.log('hiding column');
                    var column = oTable.column( column );
                    try {
                        column.visible( false );
                    }
                    catch(err) {
                        column.visible( false );
                    }
                });
                // var Table = $('#structures').dataTable();
                // Table.fnDraw();
                console.log('done toggle');
                oTable.draw();
                console.log('done draw');
            } );

            $('.hide_columns').click(function(evt) {
                var columns = $(this).attr('columns').split(",");
                columns.forEach(function(column) {
                    // console.log('hiding column');
                    var column = oTable.column( column );
                    try {
                        column.visible( false );
                    }
                    catch(err) {
                        column.visible( false );
                    }
                });
                oTable.draw();
            } );

            // $('#show_all').click(function() {
            //     console.log('start toggle');
            //     // evt.stopPropagation();
            //     // evt.stopImmediatePropagation();
            //     // evt.preventDefault();
            //     // columns = $(this).attr('data-column').split(",");
            //     columns = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27];

            //     columns.forEach(function(column) {
            //         // console.log('hiding column');
            //         var column = oTable.column( column );
            //         try {
            //             column.visible( true );
            //         }
            //         catch(err) {
            //             column.visible( true );
            //         }
                    
            //     });
            //     // var Table = $('#structures').dataTable();
            //     // Table.fnDraw();
            //     console.log('done toggle');
            //     oTable.draw();
            //     console.log('done draw');
            // } );

            $('#superpose_btn').click(function() {
                superposition(oTable, [6,1,2,3,4,5,10,26], 'structure_browser');
            });

            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex) {
                    if ($('#representative_btn').hasClass('toggled')) {
                        if ($(oTable.row(dataIndex).node()).hasClass("repr-st")) {
                            return true;
                        }
                        return false;
                    }
                    else {
                        return true;
                    }
            });

            $('#representative_btn').click(function () {
                //class 'active' is conflicting with something else o.O
                $(this).toggleClass('toggled');
                // $('#representative_btn').classList.toggle('pressed_btn');
                oTable.draw();
            });
            $('#download_btn').click(function () {
                ClearSelection('targets');
                var checked_data = oTable.rows('.alt_selected').data();
                for (i = 0; i < checked_data.length; i++) {
                    var div = document.createElement("div");
                    div.innerHTML = checked_data[i][6];
                    if (typeof div.innerText !== "undefined") {
                        AddToSelection('targets', 'structure',  div.innerText.replace(/\s+/g, '') );
                    } else {
                        AddToSelection('targets', 'structure', div.textContent.replace(/\s+/g, ''));
                    }
                }
                window.location.href = '/structure/pdb_download_index';
            });
            $('#align_btn').click(function () {
                var checked_data = oTable.rows('.alt_selected').data();
                ClearSelection('targets');
                for (i = 0; i < checked_data.length; i++) {
                    var div = document.createElement("div");
                    div.innerHTML = checked_data[i][6];
                    if (typeof div.innerText !== "undefined") {
                        AddToSelection('targets', 'structure', div.innerText.replace(/\s+/g, ''));
                    } else {
                        AddToSelection('targets', 'structure', div.textContent.replace(/\s+/g, ''));
                    }

                }
                window.location.href = '/structure/selection_convert';
            });

            // catch_filter(oTable2, oTable);

            // matching scrolls
            var tables = document.querySelectorAll(".dataTables_scrollBody");
            var frozen_table = tables[0];
            var scrollable_table = tables[1];

            var isLeftScrollTopCalled = false;
            $(frozen_table).scroll(function (e) {
                if (isRightScrollTopCalled) {
                    return isRightScrollTopCalled = false;
                }

                $(scrollable_table).scrollTop($(this).scrollTop());
                isLeftScrollTopCalled = true;
            });

            var isRightScrollTopCalled = false;
            $(scrollable_table).scroll(function (e) {
                if (isLeftScrollTopCalled) {
                    return isLeftScrollTopCalled = false;
                }

                $(frozen_table).scrollTop($(this).scrollTop());
                isRightScrollTopCalled = true;
            });

        });

        function ClearSelection(selection_type) {
            $.ajax({
                'url': '/common/clearselection',
                'data': {
                    selection_type: selection_type
                },
                'type': 'GET',
                'async': false,
                'success': function (data) {
                    $("#selection-" + selection_type).html(data);
                }
            });
        }

        function AddToSelection(selection_type, selection_subtype, selection_id) {
            $.ajax({
                'url': '/common/addtoselection',
                'data': {
                    selection_type: selection_type,
                    selection_subtype: selection_subtype,
                    selection_id: selection_id
                },
                'type': 'GET',
                'async': false,
                'success': function(data) {
                    $("#selection-" + selection_type).html(data);
                },
            });
        }

        function select_all(e) {
            var checkedStatus = $(e).prop("checked");

            $('.select-all').each(function () {
                    $(this).prop('checked', checkedStatus);
            });

            $('.alt').each(function () {
                    $(this).prop('checked', checkedStatus);
            });
        };

        function assign_to_row(){
          $('tbody tr').click(function(event) {
            if (event.target.type !== 'checkbox') {
              $(':checkbox', this).trigger('click');
            }
          });
        }

        function match_rowheight() {
            $("#structures_scrollable").find('tr').each(function(i, e) {
                $("#structures_frozen").find('tr').eq(i).height($(this).height());
            });
        }

        function match_content(table1, table2) {
            var scrollable_ids = [];
            $("#structures_scrollable").find('tr').each(function(i, e) {
                scrollable_ids.push(i);
            });
            var rows = $("#structures_scrollable").dataTable().$('tr', {"filter":"applied"});
            console.log('ROWS',rows);
            console.log('scrollable_ids',scrollable_ids);
            $("#structures_frozen").find('tr').each(function(i, e) {
                console.log(i,e);
                if (scrollable_ids.includes(i)) {}
                else {
                    console.log(i,e);
                    table1.row(i).remove();
                    // row.remove();
                }
            });
            table1.draw();
        }

        // function catch_filter(table1, table2) {
        //     var text_multi_filter_cols = [1,2,3,4,5,6,7,9,10,12,13,14,15,16,17,18,19,20,21,22,23,24,25,27];
        //     // var filters = document.querySelectorAll("#yadcf-filter--structures_scrollable-26.yadcf-filter.select2-offscreen");
        //     text_multi_filter_cols.forEach(function(column) {
        //         var ref = "#yadcf-filter--structures_scrollable-".concat(column.toString(),".yadcf-filter.select2-offscreen");
        //         $(ref).change(function() {
        //             // match_content(table1, table2);
        //             setTimeout(function() {update_tables("structures_scrollable");}, 100);
        //             console.log($(this),' filter');
        //         });
        //     });

        //     $(".yadcf-filter-range-number.yadcf-filter-range").keydown(function() {
        //         console.log($(this),' range');
        //     });
            
        //     $(".yadcf-filter-reset-button").click(function() {
        //         console.log($(this),' reset button');
        //     });

        //     $(".yadcf-filter-range-data.yadcf-filter-range.hasDatepicker").change(function() {
        //         console.log($(this),' date range');
        //     });
        //     // console.log(filters)
        // }

        function get_row_ids(table_id) {
            var rows = [];
            var id = '#'+table_id;
            $(id).find('tr').each(function(i, e) {
                if (i>1) {
                    rows.push({key:$(e).attr('model_id'),value:[i,e]});
                }
            });
            return rows;
        }

        function reorder_table(ref_ids, target_ids, table) {
            // table.clear();
            // console.log(ref_ids);
            // console.log(target_ids);
            for (var k in ref_ids) {
                // console.log(k, ref_ids[k], target_ids[k]);
                // table.row.add(target_ids[k][1]);
            }
            return table;
        }

        function update_tables(tables) {
                if (tables=="structures_scrollable") {
                    $('#structures_frozen > tbody  > tr').hide();
                    ids = Array();
                    var rows = $("#structures_scrollable").dataTable().$('tr', {"filter":"applied"});
                    rows.each(function(i,e) {
                        console.log(i,e);
                        $("#structures_frozen > tbody > tr[model_id=" + $(e).attr('model_id') + "]").show();
                        console.log($("#structures_frozen > tbody > tr[model_id=" + $(e).attr('model_id') + "]"));
                    });
                }
                
        }

    </script> 
{% endblock %}

{% block content %}
<div id="browser">
    <div style="display:block;">
        <div style="display:inline; float:left;">
            <h2 style="width:auto; display:inline;">Structure Browser</h2>
        </div>
        <div style="float:left; padding:4px 0px 0px 6px;">
            <div style="font-size: 10px; ">
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> read article</a><br>
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> latest GPCRdb article</a>
            </div>
        </div>
    </div>
    <br><br>

        <!-- <div class="dropdown btn-group">
              <button class="btn btn-default dropdown-toggle btn-xs" type="button" data-toggle="dropdown">Selection options
              <span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a href="#">Toggle all <input class="select-all" type="checkbox" onclick="select_all(this)"></a></li>
                <li><a href="#" id="remove_sel">Remove Selected</a></li>
                <li><a href="#" id="remove_non_sel">Remove Non-selected</a></li>
              </ul>
        </div> -->

    <div class="btn-group">
        <label class="btn btn-default btn-s" id="align_btn" href="javascript:void(0)">
            Align
        </label>
        <label class="btn btn-default btn-s" id="download_btn" href="javascript:void(0)">
            Download
        </label>
        <label class="btn btn-default btn-s" id="representative_btn" href="javascript:void(0)" data-toggle="buttons">
            Show representative
        </label>
        <label class="btn btn-default btn-s" id="superpose_btn" href="javascript:void(0)">
            Superposition
        </label>
    </div>
    <!-- <div style="font-size: 10px;">For superimposition: Select (tick box) structures, and Highlight the reference template</div> -->
    <!-- <div style="font-size: 10px;">For information on activity state and &#916; distance (&#8491;) please refer to the <a href="http://docs.gpcrdb.org/structures.html">documentation</a></div>
    <div style="font-size: 10px;">On refined structures please refer to our <a href='https://academic.oup.com/nar/article/46/D1/D440/4634004'>2017 publication</a>.</div> -->
    <br />

    <!-- <div class="btn-group">
      <label class="btn btn-default btn-xs" id="show_all" href="javascript:void(0)">
        Show All Columns
      </label>
    </div> -->
        <div style="padding-top: 0px; font-size: 15px; white-space: nowrap;" id="loading_div">
        <br>Loading...
        </div>

    <div style="padding-top: 0px; font-size: 10px; white-space: nowrap; width:100%; overflow-y:hidden;" id="structures_div">
        <!-- static column -->
        <!-- <div id='structures_frozen_div' style='float:left; width:25%; overflox-x: scroll; overflow-y: hidden;' >
            <table class="display compact" id='structures_frozen'>
                <thead>
                    <tr class='over_header'>
                        <th colspan=4 class="over_header" style='text-align:right; height:35px; border-right: 0px;'></th>
                    </tr>
                    <tr>
                        <th class='no-sort checkbox_tr'><input class="select-all" type="checkbox" onclick="select_all(this)"></th>
                        <th style='height: 70px;'></th>
                        <th></th>
                        <th></th>
                        <th style="display:none;"></th>
                    </tr>
                </thead>
                <tbody>
                {% for structure in structures.all %}
                    {% if structure.representative %}
                        <tr class="repr-st" model_id='{{structure.pk}}'>
                    {% else %}
                        <tr model_id='{{structure.pk}}'>
                    {% endif %}
                        <td class="text-center"><input class="alt" type="checkbox" id="{{ structure.pk }}"></td>
                        <td><span><a href="http://www.uniprot.org/uniprot/{{ structure.protein_conformation.protein.parent.accession }}">{{ structure.protein_conformation.protein.parent.entry_short|safe }}</a></span></td>
                        <td><span><a href="/protein/{{ structure.protein_conformation.protein.parent.entry_name }}">{{ structure.protein_conformation.protein.parent.short|safe }}</a></span></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.short|safe }}</span></td>
                        <td style="display:none;">{{ structure.publication_date|date:"Y-m-d" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div> -->

        <!-- scrollable column -->
        
        <div id='structures_scrollable_div' style='display:inline-block; width:100%;'>
            <table class="display compact" id='structures_scrollable'>
                <thead>
                    <tr class='over_header'>
                        <th colspan=6 class="over_header" style='height:35px;'>RECEPTOR</th>
                        <th colspan=6 class="over_header">
                            <div class="hide_columns" columns="6,7,8,9,10,11" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            STRUCTURE
                        </th>
                        <th colspan=2 class="over_header">
                            <div class="hide_columns" columns="12,13" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            SIGNALING PROTEIN
                        </th>
                        <th colspan=2 class="over_header">
                            <div class="hide_columns" columns="14,15" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            AUXILIARY PROTEIN
                        </th>
                        <th colspan=6 class="over_header">
                            <div class="hide_columns" columns="16,17,18,19,20,21" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            LIGAND
                        </th>
                        <th colspan=2 class="over_header">
                            <div class="hide_columns" columns="22,23" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            SODIUM ION SITE
                        </th>
                        <th colspan=3 class="over_header">
                            <div class="hide_columns" columns="24,25,26" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            REFERENCE
                        </th>
                        <th colspan=1 class="over_header">
                            <div class="hide_columns" columns="27" style="float:left;display:inline;">
                                <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label>
                            </div>
                            ANNOTATED
                        </th>
                    </tr>
                    <tr>
                        <th class='no-sort checkbox_tr'><input class="select-all" type="checkbox" onclick="select_all(this)"></th>
                        <th style='height: 70px;'></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th>PDB code</th>
                        <th><a href="https://academic.oup.com/nar/article/44/D1/D356/2502664">Refined structure</a></th>
                        <th>Resolution</th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'><a href="http://docs.gpcrdb.org/structures.html">Δ distance (Å)</a></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'>PDB Date</th>
                        <th class='rightborder'></th>
                    </tr>

                </thead>
                <tbody>
                {% for structure in structures.all %}
                    {% if structure.representative %}
                        <tr class="repr-st" model_id='{{structure.pk}}'>
                    {% else %}
                        <tr model_id='{{structure.pk}}'>
                    {% endif %}
                        <td class="text-center"><input class="alt" type="checkbox" id="{{ structure.pk }}"></td>
                        <td><span><a href="http://www.uniprot.org/uniprot/{{ structure.protein_conformation.protein.parent.accession }}">{{ structure.protein_conformation.protein.parent.entry_short|safe }}</a></span></td>
                        <td><span><a href="/protein/{{ structure.protein_conformation.protein.parent.entry_name }}">{{ structure.protein_conformation.protein.parent.short|safe }}</a></span></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.short|safe }}</span></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.parent.parent.name }}</span></td>
                        <td>{{ structure.protein_conformation.protein.species.common_name }}</td>
                        <td class="text-left">
                            <a href="{{ structure.pdb_code.index}}">{{ structure.pdb_code.index}}</a>
                        </td>
                        <td>
                            {% if structure.is_refined %}
                            <a href="homology_models/{{ structure.pdb_code.index }}_refined">{{structure.pdb_code.index}}_refined</a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">{{ structure.resolution|floatformat:"1" }}</td>
                        <td class="text-center">{{ structure.preferred_chain }}</td>
                        <td>{{ structure.state.name }}</td>
                        <td class="text-center">{{ structure.distance|floatformat:"2" }}</td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_gproteins|linebreaksbr }}
                        </td>
                        <td class="text-center arrestin">
                            {{ structure.stabilizing_agents.all|only_arrestins|linebreaksbr }}
                        </td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_fusions|linebreaksbr }}
                        </td>

                        <td class="text-center antibody">
                            {{ structure.stabilizing_agents.all|only_antibodies|linebreaksbr }}
                        </td>

                        <td>
                            {% for ligand in structure.protein_conformation.protein.parent.endogenous_ligands.all %}
                              {{ ligand|safe }}<br />
                            {% empty %}
                              -
                            {% endfor %}
                        </td>
                        <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all.0.properities.ligand_type }}</td>
                        <td>
                            {% for ligand in structure.ligands.all %}
                                {% if ligand.ligand.name|safe|length > 20 %}
                                    <span title="{{ ligand.ligand.name|safe }}">{{ ligand.ligand.name|safe|cut_at_20 }}...</span>
                                {% else %}
                                    {{ ligand.ligand.name|safe }}
                                {% endif %}
                            {% for link in ligand.ligand.properities.web_links.all %}
                                <a href="{{ link}}" target="_blank">{{link.web_resource.slug}}</a>
                            {% endfor %}
                                <br />
                            {% empty %}
                                N/A
                            {% endfor %}
                        </td>
                        <td>
                            {% for ligand in structure.ligands.all %}
                            {{ ligand.ligand_role.name }}<br />
                            {% empty %}
                            N/A
                            {% endfor %}
                        </td>
                        <td>
                            {% for ligand in structure.ligands.all %}
                            {{ ligand.ligand.properities.ligand_type }}<br />
                            {% empty %}
                            N/A
                            {% endfor %}
                        </td>
                        <td>
                            {% for c in structure.construct.all %}
                             {% if c.crystallization.crystal_method %}
                                {{c.crystallization.crystal_method.name}}
                             {% else %}
                                N/A
                             {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% if structure.protein_conformation.is_sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {% if structure.sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {{ structure.publication.authors|senior_author}}
                        </td>
                        <td>
                            <a href="{{ structure.publication.web_link }}">
                            {{ structure.publication.web_link.index }}
                            </a>
                        </td>
                        <td>{{ structure.publication_date|date:"Y-m-d" }}</td>
                        <td>
                            {% if structure.annotated %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="myModal" class="modal">
  <!-- Modal content -->
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Pick reference from selection</h3>
        <br>
        <table id="modal_table" class="display compact" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th>PDB code</th>
                    <th>UniProt</th>
                    <th>IUPHAR</th>
                    <th>Rec. family</th>
                    <th>Class</th>
                    <th>Species</th>
                    <th>State</th>
                    <th>PDB Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Javascript populates the table from selected rows -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


