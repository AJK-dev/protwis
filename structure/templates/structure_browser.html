{% extends "home/base.html" %}
{% load staticfiles %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
        <style type="text/css">
        .select2-result-label{
            font-size:x-small;
            font-size: 10px;
        }

        #filters{

            font-size: 10px;
            padding:  7px 15px; 
        }

        @media (min-width: 1600px){
            #content {
                width: 1570px;
            }
        }
        @media (min-width: 1800px){
            #content {
                width: 1770px;
            }
        }

        table.dataTable.compact thead th.over_header {
            border-right: 1px solid;
            border-left: 0px solid;
            text-align: center;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead tr.over_header th {
            border-bottom: 1px solid #ccc;
        }

        table.dataTable.compact thead th.leftborder {
            border-left: 1px solid;
        }

        table.dataTable.compact thead th.rightborder {
            border-right: 1px solid;
        }

        table.dataTable.compact thead th.checkbox_tr {
            text-align: left;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead th {
            padding: 4px 16px 4px 2px;
        }
        .yadcf-filter-wrapper {
            margin-top: 0px;
        }
        input.yadcf-filter  {
            width: 100px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }
        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;

        }
    </style>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>


    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            // 'use strict';

            // var oTable;
            var oTable = $('#constructs').DataTable({
                scrollY:        "80vh",
                scrollX:        true,
                scrollCollapse: true,
                paging:         false,
                "order": [22, 'desc'],
                  columnDefs: [
                    { targets: 'no-sort', orderable: false }

                  ],
                // fixedColumns:   {
                //     leftColumns: 4,
                // }
            });

            var prev_ids = Array()
            var current_align_ids = Array()

            console.log(oTable);
            $("#constructs_div").show();
            assign_to_row();
            $("#loading_div").hide();


            yadcf.init(oTable,
                [
                    {
                        column_number : 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Gene",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        }
                    },
                    {
                        column_number : 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Receptor",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        }
                    },
                    {
                        column_number : 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Rec. family",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    }, 
                    {
                        column_number: 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Class",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number: 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Species",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    }, 
                    {
                        column_number : 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        filter_default_label: "PDB code",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    }, 
                    {
                        column_number : 7,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 8,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Pre. chain",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 9,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "State",
                        filter_reset_button_text: false,
                        filter_match_mode : "exact",
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 10,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 11,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "G-protein",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    {
                        column_number : 12,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Arrestin",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 13,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Fusion",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 14,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Antibodies",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 15,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Endo. ligand",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 16,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Ligand type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 17,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Structure ligand",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '200px',
                        }
                    },
                    {
                        column_number : 18,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Structure lig. function",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 19,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Structure lig. type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 20,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Method",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 21,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Reference",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 22,
                        filter_type: "range_date",
                        date_format: "yyyy-mm-dd",
                        select_type: 'select2',
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number : 23,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Annotated",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 24,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Refined",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 25,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Na+ binding GPCR",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 26,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Na+ in structure",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    }
                ],
                {
                    cumulative_filtering: false
                }
            );

            yadcf.exResetAllFilters(oTable);

            // $.datepicker.regional[""].dateFormat = "yy-mm-dd";
            // $.datepicker.setDefaults($.datepicker.regional['']);

            $('.alt').change(function () {
                $(this).parent().parent().toggleClass('alt_selected');
            });

            $('.select-all').change(function () {
                $('.alt').prop('checked', $(this).prop("checked"));
                $('.alt').parent().parent().toggleClass('alt_selected');
            });

            $("#remove_sel").click(function () { 
                var oTable = $('#constructs').dataTable();
                $('input:checkbox:checked').each(function () {
                    if ( $(this).is(':visible') ) {
                       id = $(this).attr('id');

                       if (id) {
                           oTable.fnDeleteRow("#"+id, null, false);
                       }
                    }
                });
               oTable.fnDraw();
            });

            $("#remove_non_sel").click(function () { 
                var oTable = $('#constructs').dataTable();
                $('input:checkbox:not(:checked)').each(function () {
                    if ( $(this).is(':visible') ) {
                       id = $(this).attr('id');
                       if (id) {
                           oTable.fnDeleteRow("#"+id, null, false);
                       }
                   }
                });
                oTable.fnDraw();
            });

            $('#apply_filter').click(function() {
                // $("#filters").toggle();
            });

            $("#OpenFilters").click(function () {
                // $("#filters").toggle();
            });

            $('.slider').slider({
              min: 30,
              max: 200,
              value: 70,
              change: function( event, ui ) {
                console.log(ui.value);
                $(".schematic-block").width(ui.value);
              }
            });

            $('[data-toggle="tooltip"]').tooltip({ container: 'body' })
            $('.table_tooltip').tooltip({ container: 'body', html: true, placement: "top"})


        $('.column_toggle').change(function(evt) {
            console.log('start toggle');
            // evt.stopPropagation();
            // evt.stopImmediatePropagation();
            // evt.preventDefault();
            columns = $(this).attr('data-column').split(",");
            var checked = this.checked;
            var checked = (this.checked ? false : true);
            columns.forEach(function(column) {
                // console.log('hiding column');
                var column = oTable.column( column );
                try {
                    column.visible( checked );
                }
                catch(err) {
                    column.visible( checked );
                }
            });
<<<<<<< HEAD
            // var Table = $('#constructs').dataTable();
            // Table.fnDraw();
            console.log('done toggle');
            oTable.draw();
            console.log('done draw');
        } );


=======
>>>>>>> dcdf03df68be50ef58b1afdbaf5b6e508806b8d7
        });

        function select_all(e) {
            var checkedStatus = $(e).prop("checked");

            $('.select-all  ').each(function () {
                    $(this).prop('checked', checkedStatus);
            });

            $('.alt').each(function () {
                    $(this).prop('checked', checkedStatus);
            });
        };

        function assign_to_row(){
          $('tbody tr').click(function(event) {
            if (event.target.type !== 'checkbox') {
              $(':checkbox', this).trigger('click');
            }
          });
        }

        function realign() {

            ids = JSON.parse($("#c_ids").val());

            // $('input:checkbox:not(:checked)').each(function () {
            $('input:checkbox:checked').each(function () {
                if ( $(this).is(':visible') ) {
                   id = $(this).attr('value');
                   if (id) { ids.push(id); }
                }
            });

            console.log(ids);

            current_align_ids = ids
            var url = '/construct/align'; 
            var posting = $.post( url, { ids: JSON.stringify(current_align_ids)  } );
              posting.done(function( data ) {
                $("#align_div").html('').append(data)

                $(function () {$('[data-toggle="tooltip"]').tooltip()})

                $(function(){
                    $('.ali-scroll-div').scroll(function(){
                        $('.ali-main-div')
                            .scrollLeft($('.ali-scroll-div').scrollLeft());
                    });
                    $('.ali-main-div').scroll(function(){
                        $('.ali-scroll-div')
                            .scrollLeft($('.ali-main-div').scrollLeft());
                    });
                });

                $(function () {$('.internal-scroll-div').css('width', $('.dynamic-div').outerWidth() );});
              });
        };


    </script> 
{% endblock %}

{% block content %}
<h2>Structure Browser</h2>

    <!-- <div class="dropdown btn-group">
          <button class="btn btn-default dropdown-toggle btn-xs" type="button" data-toggle="dropdown">Selection options
          <span class="caret"></span></button>
          <ul class="dropdown-menu">
            <li><a href="#">Toggle all <input class="select-all" type="checkbox" onclick="select_all(this)"></a></li>
            <li><a href="#" id="remove_sel">Remove Selected</a></li>
            <li><a href="#" id="remove_non_sel">Remove Non-selected</a></li>
          </ul>
    </div> -->
    Show/hide columns:
<div class="btn-group" data-toggle="buttons">
  <!-- <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Solubilzation" data-column="1,2,3,4,5,6" checked="checked"> Receptor
  </label> -->
  <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Solubilzation" data-column="6,7,8,9,10" checked="checked"> Structure
  </label>
  <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Solubilzation" data-column="11,12" checked="checked"> Signaling Protein
  </label>
  <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Solubilzation" data-column="13,14" checked="checked"> Auxiliary Protein
  </label>
  <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Solubilzation" data-column="15,16,17,18,19,20" checked="checked"> Ligand
  </label>
  <label class="btn btn-default btn-xs">
    <input class="column_toggle" type="checkbox" value="Purification" data-column="21,22,23,24,25,26" checked="checked"> Other
  </label>
</div>

<br><br>

    <div style="padding-top: 0px; font-size: 15px; white-space: nowrap;" id="loading_div">
    <br>Loading...
    </div>
</div>
<div>
    <div style="padding-top: 0px; font-size: 10px; white-space: nowrap;" id="constructs_div">
        <table width="100%" class="display compact" id="constructs">
            <thead>
                <tr class='over_header' style='max-height: 20px'>
                    <th colspan=6 class="over_header">RECEPTOR</th>
                    <th colspan=5 class="over_header">STRUCTURE</th>
                    <th colspan=2 class="over_header">SIGNALING PROTEIN</th>
                    <th colspan=2 class="over_header">AUXILIARY PROTEIN</th>
                    <th colspan=6 class="over_header">LIGAND</th>
                    <th colspan=6 class="over_header">OTHER</th>
                </tr>
                <tr>
                    <th  class='no-sort checkbox_tr'><input class="select-all" type="checkbox" onclick="select_all(this)"></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th  class='rightborder'></th>
                    <th></th>
                    <th>Resolution</th>
                    <th></th>
                    <th></th>
                    <th  class='rightborder'>Δ distance (Å)</th>
                    <th></th>
                    <th  class='rightborder'></th>
                    <th></th>
                    <th  class='rightborder'></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th  class='rightborder'></th>
                    <th></th>
                    <th>Date</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th  class='rightborder'></th>
                    <!-- <th></th>
                    <th></th>
                    <th  class='rightborder'></th> -->
                </tr>

            </thead>
            <tbody>
            {% for structure in structures.all %}
                <tr model_id='{{structure.pk}}'>
                    <td class="text-center"><input class="alt" type="checkbox" id="{{ structure.pk }}"></td>
                    <td><span>{{ structure.protein_conformation.protein.parent.entry_short|safe }}</span></td>
                    <td><span><a href="/protein/{{ structure.protein_conformation.protein.parent.entry_name }}">{{ structure.protein_conformation.protein.family.name|safe }}</a></span></td>
                    <td><span>{{ structure.protein_conformation.protein.family.parent.name|safe }}</span></td>
                    <td><span>{{ structure.protein_conformation.protein.family.parent.parent.parent.name }}</span></td>
                    <td>{{ structure.protein_conformation.protein.species.common_name }}</td>
                    <td class="text-center">
                        <a href="{{ structure.pdb_code.index}}">{{ structure.pdb_code.index}}</a>
                    </td>
                    <td class="text-center">{{ structure.resolution|floatformat:"1" }}</td>
                    <td class="text-center">{{ structure.preferred_chain }}</td>
                    <td>{{ structure.state.name }}</td>
                    <td class="text-center">{{ structure.distance|floatformat:"2" }}</td>
                    <td class="text-center gprotein">
                        {{ structure.stabilizing_agents.all|only_gproteins|linebreaksbr }}
                    </td>
                    <td class="text-center arrestin">
                        {{ structure.stabilizing_agents.all|only_arrestins }}
                    </td>
<<<<<<< HEAD
                    <td>
                        {% for sa in structure.get_fusion_proteins %}
                        {{ sa }}<br />
                        {% empty %}
                          -
                        {% endfor %}
                    </td>
                    <td>
                        {% for sa in structure.get_antibodies %}
                          {{ sa }}<br />
                        {% empty %}
                          -
                        {% endfor %}
=======
                    <td class="text-center fusion">
                        {{ structure.stabilizing_agents.all|only_fusions|linebreaksbr }}
                    </td>
                    <td class="text-center antibody">
                        {{ structure.stabilizing_agents.all|only_antibodies }}
>>>>>>> dcdf03df68be50ef58b1afdbaf5b6e508806b8d7
                    </td>
                    <td>
                        {% for ligand in structure.protein_conformation.protein.parent.endogenous_ligands.all %}
                          {{ ligand|safe }}<br />
                        {% empty %}
                          -
                        {% endfor %}
                    </td>
                    <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all.0.properities.ligand_type }}</td>
                    <td>
                        {% for ligand in structure.ligands.all %}
                        {{ ligand.ligand.name|safe }}
                        {% for link in ligand.ligand.properities.web_links.all %}
                        <a href="{{ link}}" target="_blank">{{link.web_resource.slug}}</a>
                        {% endfor %}
                        <br />
                        {% empty %}
                        N/A
                        {% endfor %}
                    </td>
                    <td>
                        {% for ligand in structure.ligands.all %}
                        {{ ligand.ligand_role.name }}<br />
                        {% empty %}
                        N/A
                        {% endfor %}
                    </td>
                    <td>
                        {% for ligand in structure.ligands.all %}
                        {{ ligand.ligand.properities.ligand_type }}<br />
                        {% empty %}
                        N/A
                        {% endfor %}
                    </td>
                    <td>
                        {% for c in structure.construct.all %}
                         {% if c.crystallization.crystal_method %}
                            {{c.crystallization.crystal_method.name}}
                         {% else %}
                            N/A
                         {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        <a href="{{ structure.publication.web_link }}">
                        {{ structure.publication.web_link.index }}
                        </a>
                    </td>
                    <td>{{ structure.publication_date|date:"Y-m-d" }}</td>
                    <td>
                        {% if structure.annotated %}
                        Yes
                        {% else %}
                        No
                        {% endif %}
                    </td>
                    <td>
                        {% if structure.is_refined %}
                        <a href="homology_models/{{ structure.pdb_code.index }}_refined">{{structure.pdb_code.index}}_refined</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if structure.protein_conformation.is_sodium %}
                        Yes
                        {% else %}
                        No
                        {% endif %}
                    </td>
                    <td>
                        {% if structure.sodium %}
                        Yes
                        {% else %}
                        No
                        {% endif %}
                    </td>           
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


